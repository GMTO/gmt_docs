

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7.9. I/O Framework &mdash; GMT Software And Controls documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/additional_style.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="GMT Software And Controls documentation" href="../../index.html"/>
        <link rel="up" title="7. Frameworks" href="component_frameworks.html"/>
        <link rel="next" title="8. Platform" href="../platform/platform.html"/>
        <link rel="prev" title="7.8. User Interface Framework" href="user_interface.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> GMT Software And Controls
          

          
            
            <img src="../../_static/logowhite.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                1.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../release_notes/index.html">Release Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Architecture and Design</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction/swcs_introduction.html">1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../requirements/requirements.html">2. Requirements Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architecture/overall_architecture.html">3. Overall Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operations/observatory_operations.html">4. Observatory Operation System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tcs/tcs_introduction.html">5. Telescope Control System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/observatory_services.html">6. Observatory Services</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="component_frameworks.html">7. Frameworks</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="domain_engineering.html">7.1. Domain Engineering</a></li>
<li class="toctree-l3"><a class="reference internal" href="code_generation.html">7.2. Framework Usage / Code Generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="core.html">7.3. Core Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="device_control.html">7.4. Device Control Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="persistence.html">7.5. Persistence Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="data_processing.html">7.6. Data Processing Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="time_distribution.html">7.7. Time Distribution Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="user_interface.html">7.8. User Interface Framework</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">7.9. I/O Framework</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#terminology">7.9.1. <em>Terminology</em></a></li>
<li class="toctree-l4"><a class="reference internal" href="#fieldbus-communication">7.9.2. <em>Fieldbus Communication</em></a></li>
<li class="toctree-l4"><a class="reference internal" href="#i-o-module-terminals">7.9.3. <em>I/O Module Terminals</em></a></li>
<li class="toctree-l4"><a class="reference internal" href="#process-image">7.9.4. <em>Process Image</em></a></li>
<li class="toctree-l4"><a class="reference internal" href="#bootstrap-process">7.9.5. <em>Bootstrap Process</em></a></li>
<li class="toctree-l4"><a class="reference internal" href="#runtime-components">7.9.6. <em>Runtime Components</em></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../platform/platform.html">8. Platform</a></li>
<li class="toctree-l2"><a class="reference internal" href="../process/process_introduction.html">9. Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../risks/risks.html">10. Software and Control Risks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bibliography/bibliography.html">11. Bibliography</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../SWC_standards/index.html">Software and Controls Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software_development/index.html">Software Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_products/index.html">Data Products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/swc_sys_glossary.html">Software and Controls Acronyms and Definitions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GMT Software And Controls</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Architecture and Design</a> &raquo;</li>
        
          <li><a href="component_frameworks.html">7. Frameworks</a> &raquo;</li>
        
      <li>7.9. I/O Framework</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="i-o-framework">
<span id="io-framework"></span><h1>7.9. I/O Framework<a class="headerlink" href="#i-o-framework" title="Permalink to this headline">¶</a></h1>
<p>The I/O Framework (IOF) provides the infrastructure to develop observatory
compliant Device Controllers based on EtherCAT technology. The Section on
<a class="reference internal" href="../platform/field_device_interface_technology.html#field-device-interface"><span class="std std-ref">Field Device Interface Technology</span></a> provides a more detailed description of EtherCAT.
The IOF provides the following capabilities:</p>
<blockquote>
<div><ul class="simple">
<li>Tools to assist developers with the definition of their application’s I/O.</li>
<li>Templates that can be reused or extended based on reference definitions and
implementations.</li>
<li>Standard environment to build, test and deploy systems.</li>
<li>Abstraction layers to keep underlying 3rd party software packages
transparent, and hide the complexity and low-level implementation details.</li>
<li>Tools to assist with prototyping, testing, debugging and validation during
all the steps of the development process.</li>
<li>Scripting capabilities and a command line interface for rapid development.</li>
</ul>
</div></blockquote>
<div class="section" id="terminology">
<h2>7.9.1. <em>Terminology</em><a class="headerlink" href="#terminology" title="Permalink to this headline">¶</a></h2>
<p>A <em>Device</em> is a real world, physical entity representing the system under
control.  A <em>device controller</em> is a standard software component (see the
<a class="reference internal" href="device_control.html#device-control-framework"><span class="std std-ref">following section</span></a>). The device controller
relays input and output signals to control hardware devices.  An <em>IOModule</em> is
a hardware independent representation of an I/O module terminal whereas the
<em>IOModuleDriver</em> provides the hardware dependent implementation, e.g., due to
vendor specific electronics implementation. An IO module terminal is a
real-world electronics component built into a hardware device assembly.</p>
<div class="figure" id="id2">
<img alt="../../_images/framework-overview.png" src="../../_images/framework-overview.png" />
<p class="caption"><span class="caption-number">Fig. 7.8 </span><span class="caption-text">Framework Overview</span></p>
</div>
<p>While particular hardware assemblies may rely on highly specialized controllers
(e.g., cameras, deformable mirrors) a substantial number of hardware assemblies
can be identified in the telescope design that rely on a limited set of
fundamental generic <a class="reference internal" href="../tcs/degrees_of_freedom.html#tcs-degrees-of-freedom"><span class="std std-ref">building blocks</span></a>. These
primitive I/O modules can be grouped into generic families:</p>
<blockquote>
<div><ul class="simple">
<li>Digital Input and Output modules</li>
<li>Analog Input and Output modules</li>
<li>Position Measurement modules</li>
<li>Motion control modules</li>
<li>Communication modules, e.g., Serial or Ethernet – often used to bridge more
integrated systems</li>
</ul>
</div></blockquote>
<p>More specialized modules, e.g., Pulse Width signal output, Thermocouple input,
etc., extend from this general classification.</p>
<p>The I/O Framework is decomposed into layers. A bootstrap layer handles
configuration and setup of the environment using SDFs. A runtime layer provides
the hooks between the bootstrapped environment and the application development
environment. The framework is logically structured into a hardware abstract
layer e.g., an <em>IOModule</em> instance of digital output family, and a hardware
dependent layer, e.g., a vendor specific unit. Although the scope of the
currently envisioned framework is really targeted at EtherCAT, other technology
can be interfaced using the same architecture.</p>
</div>
<div class="section" id="fieldbus-communication">
<h2>7.9.2. <em>Fieldbus Communication</em><a class="headerlink" href="#fieldbus-communication" title="Permalink to this headline">¶</a></h2>
<p><strong>EtherCAT Master</strong></p>
<blockquote>
<div><p>The principles of EtherCAT fieldbus communication are presented in more
details in Section on <a class="reference internal" href="../platform/field_device_interface_technology.html#field-device-interface"><span class="std std-ref">Field Device Interface Technology</span></a>. The EtherCAT technology
group (ETG) provides an ANSI-C reference implementation for EtherCAT master.
The GMT I/O Framework relies on third party software to provide this
communication layer. Different commercial and open-source implementations
have been evaluated <a class="reference internal" href="../bibliography/bibliography.html#bec12a" id="id1">[Bec12a]</a> to find which solution better suited the needs
of GMT, and to understand commonalties between different solutions.</p>
<p>The current baseline uses the EtherCAT Master (ECM) from IgH, an open source
package from the IgH EtherLab tool suite. The IgH EtherCAT master is implemented
as a Linux kernel module and provides an API to configure and operate the
EtherCAT fieldbus. The API is available in user space and kernel space for
development.</p>
<p>The IgH implementation also provides a generic network driver that will function
independently of the computer network hardware, using the Linux kernel network
stack. This approach proves very flexible but suitable for rates typically less
than 1 kHz. Specialized drivers are also provided for a couple of popular
network interface (Intel e100/e1000, Broadcom). Those bypass the network stack
and allow faster and more deterministic responses, up to 5-10 kHz cycle time
from our lab evaluation.</p>
</div></blockquote>
<p><strong>ECM Driver</strong></p>
<blockquote>
<div><p>The IgH EtherCAT master handles all aspects of the communication protocol and
state transitions. Beyond that, it does not impose any particular philosophy
or mode of operation. The GMT I/O Framework builds on top of the EtherCAT
master to provide isolation from third-party specific implementations and a
common pattern reused by all the GMT applications.</p>
<p>The ECM Driver is the main component of the I/O framework; it provides the
following capabilities:</p>
<blockquote>
<div><ul class="simple">
<li>Interfaces with the EtherCAT master implementation and exposes a
predefined operation pattern.</li>
<li>Exposes status information via the <a class="reference external" href="http://en.wikipedia.org/wiki/Sysfs">sysfs</a> file system.</li>
<li>Exposes an API to configure the application process maps and I/O modules.
The interface is available from both user-space using <a class="reference external" href="http://en.wikipedia.org/wiki/Ioctl">ioctl</a> and kernel space.</li>
<li>Exposes a top level r/w debug level flag accessible through <a class="reference external" href="http://en.wikipedia.org/wiki/Procfs">procfs</a></li>
<li>Holds the field bus configuration in terms of I/O module terminals
topology and configuration.</li>
</ul>
</div></blockquote>
<p>The EtherCAT fieldbus communication follows a master/slaves paradigm. The
fieldbus is daisy chained and the protocol uses a simple addressing mechanism
based on each slave (i.e., I/O module terminal) position on the bus. The ECM
Driver component holds a list of <em>IOModules</em> to represent this arrangement.
IOModules are described in next section.</p>
</div></blockquote>
</div>
<div class="section" id="i-o-module-terminals">
<h2>7.9.3. <em>I/O Module Terminals</em><a class="headerlink" href="#i-o-module-terminals" title="Permalink to this headline">¶</a></h2>
<p><strong>EtherCAT Slaves</strong></p>
<blockquote>
<div><p>EtherCAT Slave Controllers (ESC) provide an EtherCAT Slave Information file
(ESI), an I/O module terminal description document in XML format. Information
about the module functionality and settings is provided by the ESI. Slave
specific information (manufacturer, product information, profile, object,
process data, sync or non-sync, sync manager setting) is registered to the ESI
file in XML format.</p>
<p>ESI files are used by the I/O Framework to define the application network
information (ENI) e.g., process data structures and initialization commands.
The ESI file is defined by the ETG.2000 EtherCAT Slave Information
specification. The structure of an ESI file is defined in the EtherCATInfo.xsd
XML schema document, available from ETG.2001 EtherCAT Slave Information
annotations.</p>
</div></blockquote>
<p><strong>ECG I/O Modules</strong></p>
<blockquote>
<div><p>An <em>IOModule</em> is a base component from the I/O framework used to represent an
EtherCAT slave controller. I/O Module terminals are fully resolved by their
vendor identifier, product code, and revision number. The ETG group assigns
EtherCAT technology partners and vendors unique vendor identifiers. The I/O
framework provides tools to automatically generate <em>IOModule</em> components from
the slaves ESI definition. The components follow a naming convention for
convenience.</p>
<p><em>IOModules</em> are registered to the ECM Driver using this naming convention and
their location on the fieldbus. They expose Process Data Object (PDO) as block
of memory. The I/O framework generates a mapping of the PDO map to different
target programing languages, currently C/C++ and Python.</p>
<p>The following code blocks below together show an example of an I/O Module PDO
Mapping in C/C++ and Python:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-number">Listing 7.1 </span><span class="caption-text">I/O Module PDO Mapping (C/C++)</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">bh_el7041_00130000_sm3</span> <span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="nl">x1a01_6000_01</span> <span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// (ro) ENC Status - Status__Latch C valid</span>
    <span class="kt">uint8_t</span> <span class="nl">x1a01_6000_02</span> <span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// (ro) ENC Status - Status__Latch extern valid</span>
    <span class="kt">uint8_t</span> <span class="nl">x1a01_6000_03</span> <span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// (ro) ENC Status - Status__Set counter done</span>
    <span class="kt">uint8_t</span> <span class="nl">x1a01_6000_04</span> <span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// (ro) ENC Status - Status__Counter underflow</span>
    <span class="kt">uint8_t</span> <span class="nl">x1a01_6000_05</span> <span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// (ro) ENC Status - Status__Counter overflow</span>
    <span class="nl">uint8_t</span> <span class="p">:</span><span class="mi">2</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="nl">x1a01_6000_08</span> <span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// (ro) ENC Status - Status__Extrapolation stall</span>
    <span class="kt">uint8_t</span> <span class="nl">x1a01_6000_09</span> <span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// (ro) ENC Status - Status__Status of input A</span>
    <span class="p">...</span>
    <span class="kt">uint32_t</span> <span class="n">x1a06_6020_11</span><span class="p">;</span>   <span class="c1">// (ro) POS Status - Actual position</span>
    <span class="kt">int16_t</span> <span class="n">x1a06_6020_21</span><span class="p">;</span>    <span class="c1">// (ro) POS Status - Actual velocity</span>
    <span class="kt">uint32_t</span> <span class="n">x1a06_6020_22</span><span class="p">;</span>   <span class="c1">// (ro) POS Status - Actual drive time</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-number">Listing 7.2 </span><span class="caption-text">I/O Module PDO Mapping (Python)</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">bh_el7041_00130000_sm3</span> <span class="p">(</span><span class="n">Structure</span><span class="p">)</span> <span class="p">:</span>
  <span class="n">_pack_</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;x1a01_6000_01&#39;</span><span class="p">,</span> <span class="n">c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1"># (ro) ENC Status - Status__Latch C valid</span>
    <span class="p">(</span><span class="s1">&#39;x1a01_6000_02&#39;</span><span class="p">,</span> <span class="n">c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1"># (ro) ENC Status - Status__Latch extern valid</span>
    <span class="p">(</span><span class="s1">&#39;x1a01_6000_03&#39;</span><span class="p">,</span> <span class="n">c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1"># (ro) ENC Status - Status__Set counter done</span>
    <span class="p">(</span><span class="s1">&#39;x1a01_6000_04&#39;</span><span class="p">,</span> <span class="n">c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1"># (ro) ENC Status - Status__Counter underflow</span>
    <span class="p">(</span><span class="s1">&#39;x1a01_6000_05&#39;</span><span class="p">,</span> <span class="n">c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1"># (ro) ENC Status - Status__Counter overflow</span>
    <span class="p">(</span><span class="s1">&#39;_________pad0&#39;</span><span class="p">,</span> <span class="n">c_uint8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;x1a01_6000_08&#39;</span><span class="p">,</span> <span class="n">c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1"># (ro) ENC Status - Status__Extrapolation stall</span>
    <span class="p">(</span><span class="s1">&#39;x1a01_6000_09&#39;</span><span class="p">,</span> <span class="n">c_uint8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1"># (ro) ENC Status - Status__Status of input A</span>
    <span class="o">...</span>
    <span class="p">(</span><span class="s1">&#39;x1a06_6020_11&#39;</span><span class="p">,</span> <span class="n">c_uint32</span><span class="p">),</span>   <span class="c1"># (ro) POS Status - Actual position</span>
    <span class="p">(</span><span class="s1">&#39;x1a06_6020_21&#39;</span><span class="p">,</span> <span class="n">c_int16</span><span class="p">),</span>    <span class="c1"># (ro) POS Status - Actual velocity</span>
    <span class="p">(</span><span class="s1">&#39;x1a06_6020_22&#39;</span><span class="p">,</span> <span class="n">c_uint32</span><span class="p">),</span>   <span class="c1"># (ro) POS Status - Actual drive time</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
</div></blockquote>
<p>Once registered to the ECM Driver, each <em>IOModule</em> instance exposes status
information and its PDO mapping via the sysfs file system.</p>
<p>The Table below shows an ECG I/O Module sysfs (EL7041 at position 10):</p>
<table border="1" class="docutils" id="id5">
<caption><span class="caption-number">Table 7.13 </span><span class="caption-text">ECG I/O Module <em>sysfs</em> (EL7041 at position 10)</span><a class="headerlink" href="#id5" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="38%" />
<col width="11%" />
<col width="51%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">sysfs</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Type</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">Description</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">iom/dev10_EL7041/al_state</div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">int</div>
<div class="line"><br /></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Application Layer state 0:INIT, 1:PREOP,</div>
<div class="line">2:SAFEOP, 3:OP)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">iom/dev10_EL7041online</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">int</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">IO Module online state</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">iom/dev10_EL7041operational</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">int</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">IO Module operational flag</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">iom/dev10_EL7041/1a01_6000_01</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">bit</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(ro) ENC Status – Status Latch C valid</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">iom/dev10_EL7041/1a01_6000_02</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">bit</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(ro) ENC Status – Status Latch extern valid</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="process-image">
<h2>7.9.4. <em>Process Image</em><a class="headerlink" href="#process-image" title="Permalink to this headline">¶</a></h2>
<p><strong>EtherCAT Frames</strong></p>
<blockquote>
<div>The ECM Driver handles the registration of all the <em>IOModules</em> and their
mapping into EtherCAT frames. EtherCAT frames are cyclically sent and
received by the master at the base frame rate defined by a “freq” parameter.
The I/O framework allows mapping of certain regions of the I/O modules at
multiple of the base rate, i.e., those PDO only update every n-th frames of
the nominal rate. The complete process image contained in the EtherCAT frame
can be thus split into separate logical regions.</div></blockquote>
<p><strong>ECM Domains</strong></p>
<blockquote>
<div><p>An ECM Domain is a base component of the I/O framework used to represent a
sub region of an EtherCAT frame updating at a given rate. The rate is a
fraction of the nominal rate and currently supports power of two values,
i.e., x1, x2, x4, ... x128. During system initialization, ECM Domains are
initially defined and <em>IOModules</em> register their PDO mapping into those
domains.</p>
<p>In its simplest form, an application may simply consist of a unique domain,
which will be used by all the modules and contains the complete process
image that updates at the nominal (x1) base rate. Once registered to the ECG
Master, each ECG Domain instance exposes status information and its fraction
of the process image via the sysfs file system.</p>
<p>The Table below shows an example of the Process Map sysfs:</p>
</div></blockquote>
<table border="1" class="docutils" id="id6">
<caption><span class="caption-number">Table 7.14 </span><span class="caption-text">Process Map <em>sysfs</em></span><a class="headerlink" href="#id6" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="30%" />
<col width="12%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">sysfs</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>pmap/dom00/data</td>
<td>bytes[]</td>
<td>Domain process image memory map (mmap)</td>
</tr>
<tr class="row-odd"><td>pmap/dom00/domain_size</td>
<td>int</td>
<td>Number of bytes in data</td>
</tr>
<tr class="row-even"><td>pmap/dom00/wc_state</td>
<td>int</td>
<td>Working counter state (0: complete, 1: incomplete)</td>
</tr>
<tr class="row-odd"><td>pmap/dom00/working_counter</td>
<td>int</td>
<td>Working counter value</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="bootstrap-process">
<h2>7.9.5. <em>Bootstrap Process</em><a class="headerlink" href="#bootstrap-process" title="Permalink to this headline">¶</a></h2>
<p>The framework provides all the capability to configure and bootstrap a new
application. The process can be done programmatically at different level:
kernel, user-space C/C++, python – in decreasing order of complexity.</p>
<p>The framework provides an API to configure Service Data Objects (SDO) and
Distributed Clock (DC) settings for each IO Module. Details are not presented
here but essentially consist of straightforward ioctl binding as listed in the
previous section. The resulting API provides seamless integration with the GMT
modeling framework and fosters the automatic generation of bootstrap components
based on model application definitions. Once bootstrapped, the I/O framework
cyclically runs the complete EtherCAT stack.</p>
<p>The code (Python) below shows an example of an Application Bootstrap:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gmt</span> <span class="kn">import</span> <span class="n">ecx</span>
<span class="kn">from</span> <span class="nn">gmt.ecx</span> <span class="kn">import</span> <span class="n">nth</span><span class="p">,</span> <span class="n">acc</span>

<span class="c1"># acquire master</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">ecx</span><span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># register domains</span>
<span class="n">dinp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">domain_register</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nth</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">acc</span><span class="o">.</span><span class="n">ro</span><span class="p">)</span>
<span class="n">dout</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">domain_register</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nth</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">acc</span><span class="o">.</span><span class="n">wo</span><span class="p">)</span>

<span class="c1"># register devices</span>
<span class="n">m</span><span class="o">.</span><span class="n">device_register</span><span class="p">(</span><span class="s1">&#39;bh_ek1100_00110000&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">device_register</span><span class="p">(</span><span class="s1">&#39;bh_el2202_00100000&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">device_register</span><span class="p">(</span><span class="s1">&#39;km_akd_00000002&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">inp</span> <span class="o">=</span> <span class="n">dinp</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">dout</span><span class="p">)</span>

<span class="c1"># activate @ 1 kHz</span>
<span class="n">m</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="runtime-components">
<h2>7.9.6. <em>Runtime Components</em><a class="headerlink" href="#runtime-components" title="Permalink to this headline">¶</a></h2>
<p>The I/O framework provides additional runtime components to interface with the
bootstrapped application.</p>
<p><strong>ECM Fieldbus</strong></p>
<blockquote>
<div><p>The ECM Fieldbus component is a front end to the kernel spaces components. In
particular, ECM:</p>
<blockquote>
<div><ul class="simple">
<li>Runs the EtherCAT stack cyclically, taking over from the free-wheeling ECM
Driver.</li>
<li>Checks health of the different kernel components, e.g., ECM Driver link
up, slaves responding, I/OModule’s al_state, ECG domain’s working_counter,
etc. and raises appropriate alarms.</li>
<li>Arbitrates access to the process maps in between cycle.</li>
</ul>
</div></blockquote>
</div></blockquote>
<p><strong>ECM I/O Drivers</strong></p>
<blockquote>
<div><p>ECM I/O Drivers provide reference implementations for the control of their I/O
Modules. The I/O drivers interact with the ECM Driver to access the I/O module
process maps in a synchronized way. I/O Drivers can be very simple, e.g., a
digital output driver that only needs to set a bit in the I/O module process
map, or more involved, e.g., implement CiA402 motion profile state machine.</p>
<p>The ECG I/O Drivers essentially allow hiding the low level details of control,
and enforcing data synchronization when accessing the fieldbus.</p>
</div></blockquote>
<p><strong>BaseDeviceController</strong></p>
<blockquote>
<div><p>The BaseDeviceController component is part of the <a class="reference internal" href="device_control.html#device-control-framework"><span class="std std-ref">Device Control Framework</span></a>
and provides a base implementation for all GMT components implementing a
Device Controller. The components provide:</p>
<ul class="simple">
<li>An environment holding the <em>IOModules</em>, <em>IODrivers</em> and <em>Fieldbus</em>
instances, and access to those components.</li>
<li>Adapters to Observatory Services, e.g., logging, telemetry, alarms, etc..</li>
<li>Adapters to middleware to expose commands, process data, etc. to the rest of
the control system.</li>
</ul>
<p>The framework provides an API for developers to build their own application,
and python binding for rapid prototyping, testing, and validation.</p>
<p>The code (Python) below shows an example of an Application Runtime:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gmt</span> <span class="kn">import</span> <span class="n">ecx</span>

<span class="c1"># load application</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">ecx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;demo&#39;</span><span class="p">)</span>

<span class="c1"># lookup component</span>
<span class="n">km</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">lkup</span><span class="p">(</span><span class="s1">&#39;demo://dev/km_akd&#39;</span><span class="p">)</span>

<span class="c1"># device control</span>
<span class="k">def</span> <span class="nf">when_done</span><span class="p">(</span><span class="n">status</span><span class="p">):</span> <span class="k">pass</span>
<span class="n">km</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<span class="n">km</span><span class="o">.</span><span class="n">datum</span><span class="p">()</span>
<span class="n">km</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="n">when_done</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../platform/platform.html" class="btn btn-neutral float-right" title="8. Platform" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="user_interface.html" class="btn btn-neutral" title="7.8. User Interface Framework" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, contributors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.4-1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>