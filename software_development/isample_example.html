

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4. ISample Example &mdash; GMT Software And Controls documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/additional_style.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="GMT Software And Controls documentation" href="../index.html"/>
        <link rel="up" title="Software Development" href="index.html"/>
        <link rel="next" title="5. DCS Development" href="development.html"/>
        <link rel="prev" title="3. Installing a Virtual Machine" href="virtual_machine/virtual_machine.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> GMT Software And Controls
          

          
            
            <img src="../_static/logowhite.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../release_notes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SWC_architecture/index.html">Architecture and Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SWC_standards/index.html">Software and Controls Standards</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Software Development</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installation.html">1. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade.html">2. Upgrade</a></li>
<li class="toctree-l2"><a class="reference internal" href="virtual_machine/virtual_machine.html">3. Installing a Virtual Machine</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4. ISample Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#model-files">4.1. Model Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code-generation">4.2. Code Generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#component-attributes">4.3. Component Attributes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#state-variables">4.3.1. State Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#input-ports">4.3.2. Input Ports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#output-ports">4.3.3. Output Ports</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#configuration">4.4. Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#c-executables">4.4.1. C++ Executables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#coffee-config-files">4.4.2. Coffee Config Files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#defining-component-behavior">4.5. Defining component behavior</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compilation">4.6. Compilation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-example">4.7. Running the Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sending-a-value-to-the-input-port">4.8. Sending a Value to the Input Port</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="development.html">5. DCS Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">6. Developer Info and Release Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="services.html">7. Using the Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html">8. Running Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="contribute.html">9. Contribute</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../data_products/index.html">Data Products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary/swc_sys_glossary.html">Software and Controls Acronyms and Definitions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GMT Software And Controls</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Software Development</a> &raquo;</li>
        
      <li>4. ISample Example</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="isample-example">
<span id="id1"></span><h1>4. ISample Example<a class="headerlink" href="#isample-example" title="Permalink to this headline">¶</a></h1>
<p><a class="reference internal" href="development/specification/specification.html#dcs-spec-example"><span class="std std-ref">ISample DCS</span></a> is an instrument control system example that provides
a template that instrument developers can use as a model.</p>
<p>Retrieve the sample model files from <a class="reference external" href="../_static/isample_dcs.tgz">here</a> or execute:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ curl -O http://52.52.46.32/_static/isample_dcs.tgz
$ tar xvfz isample_dcs.tgz
$ <span class="nb">cd</span> isample_dcs
</pre></div>
</div>
<p>For relative and absolute paths, it will be assumed that the tar file was downloaded to the current user’s home directory (~/).</p>
<div class="section" id="model-files">
<h2>4.1. Model Files<a class="headerlink" href="#model-files" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>isample_def.coffee</dt>
<dd>High-level definition file, representing the WBS for the submodule. It lists the components and how many instances of each are required.</dd>
<dt>isample_dcs.coffee</dt>
<dd>Lists the connectors between the supervisor layer and the component layer. For this example, these are limited to monitoring the heartbeat of each component.</dd>
<dt>isample_ctrl_pkg/isample_ctrl_pkg.coffee</dt>
<dd>Lists the connectors between components.</dd>
<dt>isample_ctrl_pkg/isample_ctrl_super.coffee</dt>
<dd>Definition of the <em>Control Supervisor</em> component. State variables, input and output ports are specified here. A single instance called <strong>isample_ctrl_super</strong> will be created.</dd>
<dt>isample_ctrl_pkg/isample_filter_wheel_ctrl.coffee</dt>
<dd>Definition of the <em>Filter Wheel Controller</em> component. State variables, input and output ports are specified here. Two instances, called <strong>isample_fw1_ctrl</strong> and <strong>isample_fw2_ctrl</strong> will be created.</dd>
<dt>isample_ctrl_pkg/isample_focus_ctrl.coffee</dt>
<dd>Definition of the <em>Focus Controller</em> component. State variables, input and output ports are specified here. A single instance called <strong>isample_focus_ctrl</strong> will be created.</dd>
<dt>isample_ctrl_pkg/isample_hw_adapter.coffee</dt>
<dd>Definition of the <em>Hardware Adapter</em> component, used to interface with the isample Actuators and Sensors. State variables, input and output ports are specified here. A single instance called <strong>isample_hw_ctrl</strong> will be created.</dd>
<dt>isample_ctrl_pkg/isample_temp_ctrl.coffee</dt>
<dd>Definition of the <em>Temperature Controller</em> component. State variables, input and output ports are specified here. Two instances, called <strong>isample_cryo_internal_temp_ctrl</strong> and <strong>isample_cryo_external_temp_ctrl</strong> will be created.</dd>
</dl>
<div class="highlight-bash"><div class="highlight"><pre><span></span>  Control                   Internal                     Hardware
 Supervisor               Temp Control                    Adapter
+--------------+         +-------------+             +---------------+
<span class="p">|</span>              <span class="p">|</span>&lt;--------<span class="p">|</span>heartbeat    <span class="p">|</span>             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>             <span class="p">|</span>             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>  temperature<span class="p">|</span>&lt;------------<span class="p">|</span>int temp       <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +-------------+             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>             External                <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>           Temp Control              <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +-------------+             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>&lt;--------<span class="p">|</span>heartbeat    <span class="p">|</span>             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>             <span class="p">|</span>             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>  temperature<span class="p">|</span>&lt;------------<span class="p">|</span>ext temp       <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +-------------+             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>           Filter Wheel              <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>            Control <span class="m">1</span>                <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +--------------+            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>&lt;--------<span class="p">|</span>heartbeat     <span class="p">|</span>            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>              <span class="p">|</span>            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span> motor control<span class="p">|</span>-----------&gt;<span class="p">|</span>fw1 control    <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>   motor state<span class="p">|</span>&lt;-----------<span class="p">|</span>fw1 state      <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +--------------+            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>           Filter Wheel              <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>            Control <span class="m">2</span>                <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +--------------+            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>&lt;--------<span class="p">|</span>heartbeat     <span class="p">|</span>            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>              <span class="p">|</span>            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span> motor control<span class="p">|</span>-----------&gt;<span class="p">|</span>fw2 control    <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>   motor state<span class="p">|</span>&lt;-----------<span class="p">|</span>fw2 state      <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +--------------+            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>           Focus Control             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +--------------+            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>&lt;--------<span class="p">|</span>heartbeat     <span class="p">|</span>            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>              <span class="p">|</span>            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>    hmi output<span class="p">|</span>-----------&gt;<span class="p">|</span>LEDs           <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span> motor control<span class="p">|</span>-----------&gt;<span class="p">|</span>focus control  <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>     hmi input<span class="p">|</span>&lt;-----------<span class="p">|</span>buttons        <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>   motor state<span class="p">|</span>&lt;-----------<span class="p">|</span>focus state    <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +--------------+            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>&lt;------------------------------------<span class="p">|</span>heartbeat      <span class="p">|</span>
+--------------+                                     +---------------+
</pre></div>
</div>
</div>
<div class="section" id="code-generation">
<h2>4.2. Code Generation<a class="headerlink" href="#code-generation" title="Permalink to this headline">¶</a></h2>
<p>To generate the code skeleton from the model files, execute:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ gds codegen -e isample_dcs
</pre></div>
</div>
<p>This will generate the basic framework of source code and configuration files for each component. The files will be located in the <cite>src/</cite> folder.
To see the generated folders and files, navigate to:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> src/runtime/src/idcs/isample_dcs/
$ ls -la
</pre></div>
</div>
</div>
<div class="section" id="component-attributes">
<h2>4.3. Component Attributes<a class="headerlink" href="#component-attributes" title="Permalink to this headline">¶</a></h2>
<p>Components are defined by their state variables, input ports, output ports and step function.</p>
<p>The Filter Wheel component has the following attributes:</p>
<div class="section" id="state-variables">
<h3>4.3.1. State Variables<a class="headerlink" href="#state-variables" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="20%" />
<col width="45%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Name</th>
<th class="head">Range</th>
<th class="head">Default</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>float</td>
<td>position_sv</td>
<td>min: 5, max: 40</td>
<td>20</td>
</tr>
<tr class="row-odd"><td>OperationalState</td>
<td>ops_state_sv</td>
<td><div class="first last line-block">
<div class="line">OFF, STARTING, ON, INITIALIZING,</div>
<div class="line">RUN, HALTING, SHUTTING_DOWN,</div>
<div class="line">FAULT, RESETTING, DISABLED</div>
</div>
</td>
<td>OFF</td>
</tr>
<tr class="row-even"><td>SimulationMode</td>
<td>sim_mode_sv</td>
<td>SIMULATION, ON_LINE</td>
<td>ON_LINE</td>
</tr>
<tr class="row-odd"><td>ControlMode</td>
<td>control_mode_sv</td>
<td>STANDALONE, INTEGRATED</td>
<td>STANDALONE</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><em>OperationalState, SimulationMode and ControlMode are enums with their respective values shown in the “Range” column above.</em></p>
</div>
<div class="section" id="input-ports">
<h3>4.3.2. Input Ports<a class="headerlink" href="#input-ports" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="30%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Name</th>
<th class="head">Internal variable</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>isample_motor_status</td>
<td>motor_state</td>
<td>motor_state</td>
</tr>
<tr class="row-odd"><td>float</td>
<td>position_goal</td>
<td>position_sv.goal</td>
</tr>
<tr class="row-even"><td>OperationalState</td>
<td>ops_state_goal</td>
<td>ops_state_sv.goal</td>
</tr>
<tr class="row-odd"><td>SimulationMode</td>
<td>sim_mode_goal</td>
<td>sim_mode_sv.goal</td>
</tr>
<tr class="row-even"><td>ControlMode</td>
<td>control_mode_goal</td>
<td>control_mode_sv.goal</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>where the struct <cite>isample_motor_status</cite> is defined as:</p>
<blockquote>
<div><div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">isample_motor_status</span> <span class="p">{</span>
    <span class="kt">bool</span>             <span class="n">ready</span><span class="p">;</span>                   <span class="c1">// Axis Ready</span>
    <span class="kt">bool</span>             <span class="n">enabled</span><span class="p">;</span>                 <span class="c1">// Axis Enabled</span>
    <span class="kt">bool</span>             <span class="n">warning</span><span class="p">;</span>                 <span class="c1">// Axis Warning</span>
    <span class="kt">bool</span>             <span class="n">error</span><span class="p">;</span>                   <span class="c1">// Axis Error</span>
    <span class="kt">bool</span>             <span class="n">moving_positive</span><span class="p">;</span>         <span class="c1">// Axis Moving +</span>
    <span class="kt">bool</span>             <span class="n">moving_negative</span><span class="p">;</span>         <span class="c1">// Axis Moving -</span>
    <span class="n">MSGPACK_DEFINE_MAP</span><span class="p">(</span><span class="n">ready</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">warning</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">moving_positive</span><span class="p">,</span> <span class="n">moving_negative</span><span class="p">)</span>
<span class="p">};</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="output-ports">
<h3>4.3.3. Output Ports<a class="headerlink" href="#output-ports" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="30%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Name</th>
<th class="head">Internal Variable</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>isample_motor_control</td>
<td>motor_control</td>
<td>motor_control</td>
</tr>
<tr class="row-odd"><td>HeartBeatEvent</td>
<td>heartbeat_out</td>
<td>heartbeat_out</td>
</tr>
<tr class="row-even"><td>float</td>
<td>position_value</td>
<td>position_sv.value</td>
</tr>
<tr class="row-odd"><td>OperationalState</td>
<td>ops_state_value</td>
<td>ops_state_sv.value</td>
</tr>
<tr class="row-even"><td>SimulationMode</td>
<td>sim_mode_value</td>
<td>sim_mode_sv.value</td>
</tr>
<tr class="row-odd"><td>ControlMode</td>
<td>control_mode_value</td>
<td>control_mode_sv.value</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>where the struct <cite>isample_motor_control</cite> is defined as:</p>
<blockquote>
<div><div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">isample_motor_control</span> <span class="p">{</span>
    <span class="kt">bool</span>             <span class="n">enable</span><span class="p">;</span>                  <span class="c1">// Axis Enable</span>
    <span class="kt">bool</span>             <span class="n">reset</span><span class="p">;</span>                   <span class="c1">// Axis Reset</span>
    <span class="kt">int16_t</span>          <span class="n">velocity</span><span class="p">;</span>                <span class="c1">// Velocity</span>
    <span class="n">MSGPACK_DEFINE_MAP</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span> <span class="n">velocity</span><span class="p">)</span>
<span class="p">};</span>
</pre></div>
</div>
</div></blockquote>
<p>and the struct <cite>HeartBeatEvent</cite> is defined as:</p>
<blockquote>
<div><div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">HeartBeatEvent</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">timeval</span>   <span class="n">timestamp</span><span class="p">;</span>               <span class="c1">// Time stamp</span>
    <span class="n">MSGPACK_DEFINE_MAP</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
<span class="p">};</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="configuration">
<h2>4.4. Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>All component instances require a unique setup port, used to send configuration parameters to the running instance.
The port on which the component instance listens for configuration parameters is defined in the corresponding <em>*_run.cpp</em> file.
The port to which configuration parameters will be sent (using gds) for each component is defined in the corresponding <em>*_config.coffee</em> configuration file.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The examples use the text editor <em>vim</em>, which is included in almost all Linux distributions,
but any other text editor can be used.</p>
<p class="last">To edit a file while viewing it in vim, type <code class="docutils literal"><span class="pre">i</span></code>. To save and exit, hit <code class="docutils literal"><span class="pre">esc</span></code>, then type <code class="docutils literal"><span class="pre">:wq</span></code>.</p>
</div>
<div class="section" id="c-executables">
<h3>4.4.1. C++ Executables<a class="headerlink" href="#c-executables" title="Permalink to this headline">¶</a></h3>
<p>For each component, ensure that the setup ports specified in the C++ files that instantiates components are unique, and matches the setup port specified in the corresponding <em>*_config.coffee</em> files.</p>
<p>For example, the file <em>isample_filter_wheel_ctrl_run.cpp</em> instantiates the two filter wheel controllers, each on its own setup port.
These setup ports need to be unique within the executable and match the setup port numbers defined in the <em>*_config.coffee</em> files, which we’ll edit next.</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> isample_ctrl_pkg/isample_filter_wheel_ctrl/cpp/
$ vim isample_filter_wheel_ctrl_run.cpp
</pre></div>
</div>
</div></blockquote>
<p>When executed, this file will create the two Filter Wheel controller instances.
Ensure that they listen for configuration parameters on the correct setup ports
by creating <em>isample_fw1_ctrl</em> on port 8000 and <em>isample_fw2_ctrl</em> on port 8001.</p>
<p>At first, we’ll use the <em>run_isample_filter_wheel_ctrl</em> executable (created
using the isample_filter_wheel_ctrl_run.cpp file) to test the Filter Wheel controllers
in isolation. To run all components at the same time, the same concept applies
to the <em>run_isample_ctrl_pkg_main</em> executable using <em>isample_ctrl_pkg_main_run.cpp</em>.</p>
</div>
<div class="section" id="coffee-config-files">
<h3>4.4.2. Coffee Config Files<a class="headerlink" href="#coffee-config-files" title="Permalink to this headline">¶</a></h3>
<p>Edit the coffee file containing the configuration for each component instance</p>
<p>For example, for the two Filter Wheel Controller instances:</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ../coffee/
$ vim isample_fw1_ctrl_config.coffee
$ vim isample_fw2_ctrl_config.coffee
</pre></div>
</div>
</div></blockquote>
<div class="section" id="instance-duplicates">
<h4>4.4.2.1. Instance duplicates<a class="headerlink" href="#instance-duplicates" title="Permalink to this headline">¶</a></h4>
<p>For components with multiple instances, such as the filter wheel controller and
the temperature controller, the <em>*_config.coffee</em> files contain all instances
in all files. Remove the duplicate instance configurations from each file.</p>
<p>This is a known issue caused by the code generator.</p>
<p>To clean up the files, the configuration for the <em>isample_fw2_ctrl</em> component
should be removed from <em>isample_fw1_ctrl_config.coffee</em> and the configuration
for the <em>isample_fw1_ctrl</em> component should be removed from
<em>isample_fw2_ctrl_config.coffee</em>.</p>
</div>
<div class="section" id="setup-ports">
<h4>4.4.2.2. Setup Ports<a class="headerlink" href="#setup-ports" title="Permalink to this headline">¶</a></h4>
<p>Under the <strong>Properties</strong> sections, set <strong>Port</strong> to 8000 for <em>isample_fw1_ctrl</em>
and 8001 for <em>isample_fw2_ctrl</em>. This will ensure that when the component is
configured during runtime, the parameters will be sent to the correct ports,
as configured above.</p>
</div>
<div class="section" id="max-rate-value">
<h4>4.4.2.3. Max Rate Value<a class="headerlink" href="#max-rate-value" title="Permalink to this headline">¶</a></h4>
<p>Ensure that all input and output ports have their <strong>max_rate</strong> value set to 1.
In some cases the max_rate value is set to <em>undefined</em>, which will cause an
error when running and using the component.</p>
<p>This is a known issue caused by the code generator and will be fixed in
subsequent versions.</p>
</div>
<div class="section" id="input-and-output-port-assignments">
<h4>4.4.2.4. Input and Output Port Assignments<a class="headerlink" href="#input-and-output-port-assignments" title="Permalink to this headline">¶</a></h4>
<p>Assign a unique port number for all input and output ports, with the exception
of connections where the port number for an output port on one component needs
to correspond to the port number for the corresponding input port on another
component.</p>
<p>For example, the <em>motor_control</em> output port on <em>isample_fw1_ctrl</em> should have
the same port number as the <em>fw1_motor_control</em> input port on <em>isample_hw_adapter</em>.</p>
<p>Here is an example of the port assignments for the filter wheel components (not all ports are listed):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>               Filter Wheel                              Hardware
             Control <span class="m">1</span> <span class="o">(</span><span class="m">8000</span><span class="o">)</span>                           Adapter <span class="o">(</span><span class="m">8030</span><span class="o">)</span>
         +---------------------+                   +---------------------+
    <span class="m">9011</span> <span class="p">|</span>                     <span class="p">|</span>                   <span class="p">|</span>                     <span class="p">|</span>
&lt;--------<span class="p">|</span> heartbeat_out       <span class="p">|</span>                   <span class="p">|</span>                     <span class="p">|</span>
         <span class="p">|</span>                     <span class="p">|</span>       <span class="m">8007</span>        <span class="p">|</span>                     <span class="p">|</span>
         <span class="p">|</span>       motor_control <span class="p">|</span>------------------&gt;<span class="p">|</span> fw1_motor_control   <span class="p">|</span>
         <span class="p">|</span>                     <span class="p">|</span>       <span class="m">8002</span>        <span class="p">|</span>                     <span class="p">|</span>
         <span class="p">|</span>         motor_state <span class="p">|</span>&lt;------------------<span class="p">|</span> fw1_motor_status    <span class="p">|</span>
         <span class="p">|</span>                     <span class="p">|</span>                   <span class="p">|</span>                     <span class="p">|</span>
         <span class="p">|</span>                     <span class="p">|</span> <span class="m">8003</span>              <span class="p">|</span>                     <span class="p">|</span>
         <span class="p">|</span>       position_goal <span class="p">|</span>&lt;--------          <span class="p">|</span>                     <span class="p">|</span>
    <span class="m">8009</span> <span class="p">|</span>                     <span class="p">|</span>                   <span class="p">|</span>                     <span class="p">|</span>
&lt;--------<span class="p">|</span> position_value      <span class="p">|</span>                   <span class="p">|</span>                     <span class="p">|</span>
         +---------------------+                   <span class="p">|</span>                     <span class="p">|</span>
                                              <span class="m">9011</span> <span class="p">|</span>                     <span class="p">|</span>
                                          &lt;--------<span class="p">|</span> heartbeat_out       <span class="p">|</span>
               Filter Wheel                        <span class="p">|</span>                     <span class="p">|</span>
             Control <span class="m">2</span> <span class="o">(</span><span class="m">8001</span><span class="o">)</span>                      <span class="p">|</span>                     <span class="p">|</span>
         +---------------------+                   <span class="p">|</span>                     <span class="p">|</span>
    <span class="m">9011</span> <span class="p">|</span>                     <span class="p">|</span>                   <span class="p">|</span>                     <span class="p">|</span>
&lt;--------<span class="p">|</span> heartbeat_out       <span class="p">|</span>                   <span class="p">|</span>                     <span class="p">|</span>
         <span class="p">|</span>                     <span class="p">|</span>       <span class="m">8018</span>        <span class="p">|</span>                     <span class="p">|</span>
         <span class="p">|</span>       motor_control <span class="p">|</span>------------------&gt;<span class="p">|</span> fw2_motor_control   <span class="p">|</span>
         <span class="p">|</span>                     <span class="p">|</span>       <span class="m">8013</span>        <span class="p">|</span>                     <span class="p">|</span>
         <span class="p">|</span>         motor_state <span class="p">|</span>&lt;------------------<span class="p">|</span> fw2_motor_status    <span class="p">|</span>
         <span class="p">|</span>                     <span class="p">|</span>                   <span class="p">|</span>                     <span class="p">|</span>
         <span class="p">|</span>                     <span class="p">|</span> <span class="m">8014</span>              <span class="p">|</span>                     <span class="p">|</span>
         <span class="p">|</span>       position_goal <span class="p">|</span>&lt;--------          <span class="p">|</span>                     <span class="p">|</span>
    <span class="m">8020</span> <span class="p">|</span>                     <span class="p">|</span>                   <span class="p">|</span>                     <span class="p">|</span>
&lt;--------<span class="p">|</span> position_value      <span class="p">|</span>                   <span class="p">|</span>                     <span class="p">|</span>
         +---------------------+                   +---------------------+
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="defining-component-behavior">
<h2>4.5. Defining component behavior<a class="headerlink" href="#defining-component-behavior" title="Permalink to this headline">¶</a></h2>
<p>The core component behavior is specified in the *_step.cpp file. The component has a periodic thread that reads input from the input ports, runs the step function and then writes output to the output ports. Initially, the generated step function will check whether the component is correctly configured and if so, will log the current step counter value.</p>
<p>For more information, and in relation to a simpler example, see <a class="reference internal" href="examples.html#running-examples"><span class="std std-ref">Running Examples</span></a></p>
<p>In the following examples we will replace the basic step functionality with common controller commands.</p>
<p>To edit the <em>Filter Wheel Controller</em> step file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/isample_dcs/src/runtime/src/idcs/isample_dcs/
$ <span class="nb">cd</span> isample_ctrl_pkg/isample_filter_wheel_ctrl/cpp/
$ vim isample_filter_wheel_ctrl_step.cpp
</pre></div>
</div>
<p>The following example step function for the filter wheel controller validates positional input and increments or decrements the position value.</p>
<blockquote>
<div><div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">IsampleFilterWheelCtrl</span><span class="o">::</span><span class="n">step</span><span class="p">(</span><span class="kt">bool</span> <span class="n">setup_ok</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">setup_ok</span><span class="p">)</span> <span class="p">{</span>                     <span class="c1">// this will be executed only if port setup has been received</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_step_rate</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">position_sv</span><span class="p">.</span><span class="n">goal</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// check range</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">position_sv</span><span class="p">.</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">log_warning</span><span class="p">(</span><span class="s">&quot;Position is at or exceeding maximum value: &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">max</span><span class="p">));</span>
                    <span class="c1">// prevent further movement</span>
                    <span class="n">position_sv</span><span class="p">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">position_sv</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// move in positive direction</span>
                    <span class="n">position_sv</span><span class="p">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">position_sv</span><span class="p">.</span><span class="n">goal</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// check range</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">position_sv</span><span class="p">.</span><span class="n">min</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">log_warning</span><span class="p">(</span><span class="s">&quot;Position is at or exceeding minimum value: &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">min</span><span class="p">));</span>
                    <span class="c1">// prevent further movement</span>
                    <span class="n">position_sv</span><span class="p">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">position_sv</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// move in negative direction</span>
                    <span class="n">position_sv</span><span class="p">.</span><span class="n">value</span> <span class="o">-=</span> <span class="mf">0.1</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// report value</span>
            <span class="n">log_info</span><span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
                     <span class="o">+</span> <span class="s">&quot; -&gt; &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">goal</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="compilation">
<h2>4.6. Compilation<a class="headerlink" href="#compilation" title="Permalink to this headline">¶</a></h2>
<p>To compile the code, run gmake:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/isample_dcs/src/runtime/src/idcs/isample_dcs/
$ gmake -j<span class="sb">`</span>nproc<span class="sb">`</span> install
$ ls install/bin
</pre></div>
</div>
<p>The executables will be located in <cite>src/runtime/src/idcs/isample_dcs/install/bin</cite>.</p>
</div>
<div class="section" id="running-the-example">
<h2>4.7. Running the Example<a class="headerlink" href="#running-the-example" title="Permalink to this headline">¶</a></h2>
<p>First, ensure that the GMT_LOG_POLICY and GMT_LOG_URL environment variables have been set. For quick testing, the following commands can be used to set the variables for the current session:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">GMT_LOG_POLICY</span><span class="o">=</span><span class="m">1</span>
$ <span class="nb">export</span> <span class="nv">GMT_LOG_URL</span><span class="o">=</span>tcp://127.0.0.1:9998
</pre></div>
</div>
<p>This may need to be done in all open sessions, if multiple sessions are used, for example to monitor logging.</p>
<p>To permanently set the environment variables, edit the ~/.bash_profile file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ vim ~/.bash_profile
</pre></div>
</div>
<p>Add the two variables at the bottom of the file, save and exit. Log out and back in to load the new environment variables.</p>
<p>Start the logging and telemetry services:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ gds log_service start <span class="p">&amp;</span>
$ gds telemetry_service start <span class="p">&amp;</span>
</pre></div>
</div>
<p>In a separate terminal (for example <cite>tty2</cite>), start the logging service client from within the isample_dcs folder.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/isample_dcs/src/runtime/src/idcs/isample_dcs/isample_ctrl_pkg/coffee
$ gds log_service client gmt
</pre></div>
</div>
<p>In the first terminal (<cite>tty1</cite>), run the Filter Wheel Controller application</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ./install/bin/run_isample_filter_wheel_ctrl <span class="p">&amp;</span>
</pre></div>
</div>
<p>The application is running in the background and will not provide any console output. All output will be directed to the logging service after the components have been successfully set up.</p>
<p>To initialize the Filter Wheel Controllers, run <cite>gds setup</cite> from within the isample_dcs folder.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> isample_ctrl_pkg/coffee
$ gds setup -m runtime -e isample_fw1_ctrl
$ gds setup -m runtime -e isample_fw2_ctrl
</pre></div>
</div>
<p>Switch to the session running the logging service client (<cite>tty2</cite>), and confirm that the component is logging step info.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In this version isample includes the specification of a control package.
All <a class="reference internal" href="../SWC_architecture/architecture/modules.html#table-control-packages"><span class="std std-ref">DCS Packages</span></a> follow the same development principles with the difference
that the Component base classes add specialized interfaces (e.g. Controller vs Pipeline). The next
incremental release of the GMT software will include examples of user interface
and data processing packages.</p>
</div>
</div>
<div class="section" id="sending-a-value-to-the-input-port">
<h2>4.8. Sending a Value to the Input Port<a class="headerlink" href="#sending-a-value-to-the-input-port" title="Permalink to this headline">¶</a></h2>
<p>In order to see the step function in action, we can write a value to an input port and see the component react to it.
While using the step function defined above, run ‘gds send_value’ with a port name and new value.</p>
<p>For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ gds send_value position_goal <span class="m">23</span> -m runtime -e isample_fw1_ctrl
</pre></div>
</div>
<p>where <strong>position_goal</strong> is the name of the input port, <strong>23</strong> is the new value to send and <strong>isample_fw1_ctrl</strong> is the component instance to send it to.</p>
<p>The log client should show messages indicating that the component is stepping from its current position to the new goal value.</p>
<p><a class="reference internal" href="#isample-example"><span class="std std-ref">[back to top]</span></a></p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="development.html" class="btn btn-neutral float-right" title="5. DCS Development" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="virtual_machine/virtual_machine.html" class="btn btn-neutral" title="3. Installing a Virtual Machine" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, contributors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.2-6',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>