

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4. ISample Example &mdash; GMT Software And Controls documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/additional_style.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="GMT Software And Controls documentation" href="../index.html"/>
        <link rel="up" title="Software Development" href="index.html"/>
        <link rel="next" title="5. Contribute" href="contribute.html"/>
        <link rel="prev" title="3. Installing a Virtual Machine" href="virtual_machine/virtual_machine.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> GMT Software And Controls
          

          
            
            <img src="../_static/logowhite.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                1.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../release_notes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SWC_architecture/index.html">Architecture and Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SWC_standards/index.html">Software and Controls Standards</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Software Development</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installation.html">1. Installing the SDK</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade.html">2. Upgrade</a></li>
<li class="toctree-l2"><a class="reference internal" href="virtual_machine/virtual_machine.html">3. Installing a Virtual Machine</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4. ISample Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#clone-the-isample-dcs-repository">4.1. Clone the isample_dcs repository</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-files">4.2. Model Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-local-node-modules">4.3. Install local Node Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code-generation">4.4. Code Generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#component-attributes">4.5. Component Attributes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#state-variables">4.5.1. State Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#input-ports">4.5.2. Input Ports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#output-ports">4.5.3. Output Ports</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#optional-defining-component-behavior">4.6. (Optional) Defining component behavior</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compilation">4.7. Compilation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-example">4.8. Running the Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#log-service">4.8.1. Log Service</a></li>
<li class="toctree-l4"><a class="reference internal" href="#component-setup">4.8.2. Component setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#telemetry-service">4.8.3. Telemetry Service</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contribute.html">5. Contribute</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../data_products/index.html">Data Products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary/swc_sys_glossary.html">Software and Controls Acronyms and Definitions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GMT Software And Controls</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Software Development</a> &raquo;</li>
        
      <li>4. ISample Example</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="isample-example">
<span id="id1"></span><h1>4. ISample Example<a class="headerlink" href="#isample-example" title="Permalink to this headline">¶</a></h1>
<p><a class="reference internal" href="development/specification/specification.html#dcs-spec-example"><span class="std std-ref">ISample DCS</span></a> is an instrument control system example that provides
a template that instrument developers can use as a model.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The following instructions assume that the SDK has been installed and the Development Environment configured correctly according to the instructions in <a class="reference internal" href="installation.html#installation"><span class="std std-ref">Installing the SDK</span></a> or <a class="reference internal" href="upgrade.html#upgrade"><span class="std std-ref">Upgrade</span></a>.</p>
</div>
<div class="section" id="clone-the-isample-dcs-repository">
<h2>4.1. Clone the isample_dcs repository<a class="headerlink" href="#clone-the-isample-dcs-repository" title="Permalink to this headline">¶</a></h2>
<p>On the development machine, clone the repository in the development folder:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GMT_LOCAL</span>/modules
$ gds clone isample_dcs -d gmto
</pre></div>
</div>
<p>where the <code class="docutils literal"><span class="pre">-d</span> <span class="pre">option</span></code> defines the git repository owner.</p>
</div>
<div class="section" id="model-files">
<h2>4.2. Model Files<a class="headerlink" href="#model-files" title="Permalink to this headline">¶</a></h2>
<p>The model files can be found in the <strong>$GMT_LOCAL/modules/ocs_isample_dcs/model/</strong> folder.</p>
<dl class="docutils">
<dt>isample_core_if.coffee</dt>
<dd>Lists the connectors between the isample and GMT core systems</dd>
<dt>isample_dcs.coffee</dt>
<dd>Lists the connectors between the supervisor layer and the component layer. For this example, these are limited to monitoring the heartbeat of each component.</dd>
<dt>isample_dcs_def.coffee</dt>
<dd>High-level definition file, representing the WBS for the submodule. It lists the components and how many instances of each are required.</dd>
<dt>isample_dcs_types.coffee</dt>
<dd>Definitions of structs and data types used by the isample components.</dd>
<dt>isample_ctrl_pkg/isample_ctrl_fb.coffee</dt>
<dd>Fieldbus definitions for the isample control package.</dd>
<dt>isample_ctrl_pkg/isample_ctrl_pkg.coffee</dt>
<dd>Lists the connectors between components.</dd>
<dt>isample_ctrl_pkg/isample_ctrl_super.coffee</dt>
<dd>Definition of the <em>Control Supervisor</em> component. State variables, input and output ports are specified here. A single instance called <strong>isample_ctrl_super</strong> will be created.</dd>
<dt>isample_ctrl_pkg/isample_filter_wheel_ctrl.coffee</dt>
<dd>Definition of the <em>Filter Wheel Controller</em> component. State variables, input and output ports are specified here. Two instances, called <strong>isample_fw1_ctrl</strong> and <strong>isample_fw2_ctrl</strong> will be created.</dd>
<dt>isample_ctrl_pkg/isample_focus_ctrl.coffee</dt>
<dd>Definition of the <em>Focus Controller</em> component. State variables, input and output ports are specified here. A single instance called <strong>isample_focus_ctrl</strong> will be created.</dd>
<dt>isample_ctrl_pkg/isample_hw_adapter.coffee</dt>
<dd>Definition of the <em>Hardware Adapter</em> component, used to interface with the isample Actuators and Sensors. State variables, input and output ports are specified here. A single instance called <strong>isample_hw_ctrl</strong> will be created.</dd>
<dt>isample_ctrl_pkg/isample_temp_ctrl.coffee</dt>
<dd>Definition of the <em>Temperature Controller</em> component. State variables, input and output ports are specified here. Two instances, called <strong>isample_cryo_internal_temp_ctrl</strong> and <strong>isample_cryo_external_temp_ctrl</strong> will be created.</dd>
</dl>
<div class="highlight-bash"><div class="highlight"><pre><span></span>  Control                   Internal                     Hardware
 Supervisor               Temp Control                    Adapter
+--------------+         +-------------+             +---------------+
<span class="p">|</span>              <span class="p">|</span>&lt;--------<span class="p">|</span>heartbeat    <span class="p">|</span>             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>             <span class="p">|</span>             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>  temperature<span class="p">|</span>&lt;------------<span class="p">|</span>int temp       <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +-------------+             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>             External                <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>           Temp Control              <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +-------------+             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>&lt;--------<span class="p">|</span>heartbeat    <span class="p">|</span>             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>             <span class="p">|</span>             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>  temperature<span class="p">|</span>&lt;------------<span class="p">|</span>ext temp       <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +-------------+             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>           Filter Wheel              <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>            Control <span class="m">1</span>                <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +--------------+            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>&lt;--------<span class="p">|</span>heartbeat     <span class="p">|</span>            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>              <span class="p">|</span>            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span> motor control<span class="p">|</span>-----------&gt;<span class="p">|</span>fw1 control    <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>   motor state<span class="p">|</span>&lt;-----------<span class="p">|</span>fw1 state      <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +--------------+            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>           Filter Wheel              <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>            Control <span class="m">2</span>                <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +--------------+            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>&lt;--------<span class="p">|</span>heartbeat     <span class="p">|</span>            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>              <span class="p">|</span>            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span> motor control<span class="p">|</span>-----------&gt;<span class="p">|</span>fw2 control    <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>   motor state<span class="p">|</span>&lt;-----------<span class="p">|</span>fw2 state      <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +--------------+            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>           Focus Control             <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +--------------+            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>&lt;--------<span class="p">|</span>heartbeat     <span class="p">|</span>            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>              <span class="p">|</span>            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>    hmi output<span class="p">|</span>-----------&gt;<span class="p">|</span>LEDs           <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span> motor control<span class="p">|</span>-----------&gt;<span class="p">|</span>focus control  <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>     hmi input<span class="p">|</span>&lt;-----------<span class="p">|</span>buttons        <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         <span class="p">|</span>   motor state<span class="p">|</span>&lt;-----------<span class="p">|</span>focus state    <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>         +--------------+            <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>                                     <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>&lt;------------------------------------<span class="p">|</span>heartbeat      <span class="p">|</span>
+--------------+                                     +---------------+
</pre></div>
</div>
</div>
<div class="section" id="install-local-node-modules">
<h2>4.3. Install local Node Modules<a class="headerlink" href="#install-local-node-modules" title="Permalink to this headline">¶</a></h2>
<p>This is a temporary work-around for a known issue with Webpack. It only needs to be run once to install the node modules under $GMT_LOCAL.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GMT_LOCAL</span>
$ cp <span class="nv">$GMT_GLOBAL</span>/package.json ./
$ npm install
</pre></div>
</div>
</div>
<div class="section" id="code-generation">
<h2>4.4. Code Generation<a class="headerlink" href="#code-generation" title="Permalink to this headline">¶</a></h2>
<p>To generate the code skeleton from the model files, execute:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GMT_LOCAL</span>/modules/ocs_isample_dcs/model
$ webpack
$ gds gen isample_dcs
</pre></div>
</div>
<p>This will generate the basic framework of source code and configuration files for each component. The files will be located in the <cite>src/</cite> folder.
To see the generated folders and files, navigate to:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GMT_LOCAL</span>/modules/ocs_isample_dcs/src/
$ ls -la
</pre></div>
</div>
</div>
<div class="section" id="component-attributes">
<h2>4.5. Component Attributes<a class="headerlink" href="#component-attributes" title="Permalink to this headline">¶</a></h2>
<p>Components are defined by their state variables, input ports, output ports and step function.</p>
<p>The Filter Wheel component has the following attributes:</p>
<div class="section" id="state-variables">
<h3>4.5.1. State Variables<a class="headerlink" href="#state-variables" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="20%" />
<col width="45%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Name</th>
<th class="head">Range</th>
<th class="head">Default</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>float</td>
<td>position_sv</td>
<td>min: 5, max: 40</td>
<td>20</td>
</tr>
<tr class="row-odd"><td>OperationalState</td>
<td>ops_state_sv</td>
<td><div class="first last line-block">
<div class="line">OFF, STARTING, ON, INITIALIZING,</div>
<div class="line">RUN, HALTING, SHUTTING_DOWN,</div>
<div class="line">FAULT, RESETTING, DISABLED</div>
</div>
</td>
<td>OFF</td>
</tr>
<tr class="row-even"><td>SimulationMode</td>
<td>sim_mode_sv</td>
<td>SIMULATION, ON_LINE</td>
<td>ON_LINE</td>
</tr>
<tr class="row-odd"><td>ControlMode</td>
<td>control_mode_sv</td>
<td>STANDALONE, INTEGRATED</td>
<td>STANDALONE</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><em>OperationalState, SimulationMode and ControlMode are enums with their respective values shown in the “Range” column above.</em></p>
</div>
<div class="section" id="input-ports">
<h3>4.5.2. Input Ports<a class="headerlink" href="#input-ports" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="30%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Name</th>
<th class="head">Internal variable</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>isample_motor_status</td>
<td>motor_state</td>
<td>motor_state</td>
</tr>
<tr class="row-odd"><td>float</td>
<td>position_goal</td>
<td>position_sv.goal</td>
</tr>
<tr class="row-even"><td>OperationalState</td>
<td>ops_state_goal</td>
<td>ops_state_sv.goal</td>
</tr>
<tr class="row-odd"><td>SimulationMode</td>
<td>sim_mode_goal</td>
<td>sim_mode_sv.goal</td>
</tr>
<tr class="row-even"><td>ControlMode</td>
<td>control_mode_goal</td>
<td>control_mode_sv.goal</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>where the struct <cite>isample_motor_status</cite> is defined as:</p>
<blockquote>
<div><div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">isample_motor_status</span> <span class="p">{</span>
    <span class="kt">bool</span>             <span class="n">ready</span><span class="p">;</span>                   <span class="c1">// Axis Ready</span>
    <span class="kt">bool</span>             <span class="n">enabled</span><span class="p">;</span>                 <span class="c1">// Axis Enabled</span>
    <span class="kt">bool</span>             <span class="n">warning</span><span class="p">;</span>                 <span class="c1">// Axis Warning</span>
    <span class="kt">bool</span>             <span class="n">error</span><span class="p">;</span>                   <span class="c1">// Axis Error</span>
    <span class="kt">bool</span>             <span class="n">moving_positive</span><span class="p">;</span>         <span class="c1">// Axis Moving +</span>
    <span class="kt">bool</span>             <span class="n">moving_negative</span><span class="p">;</span>         <span class="c1">// Axis Moving -</span>
    <span class="n">MSGPACK_DEFINE_MAP</span><span class="p">(</span><span class="n">ready</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">warning</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">moving_positive</span><span class="p">,</span> <span class="n">moving_negative</span><span class="p">)</span>
<span class="p">};</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="output-ports">
<h3>4.5.3. Output Ports<a class="headerlink" href="#output-ports" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="30%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Name</th>
<th class="head">Internal Variable</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>isample_motor_control</td>
<td>motor_control</td>
<td>motor_control</td>
</tr>
<tr class="row-odd"><td>HeartBeatEvent</td>
<td>heartbeat_out</td>
<td>heartbeat_out</td>
</tr>
<tr class="row-even"><td>float</td>
<td>position_value</td>
<td>position_sv.value</td>
</tr>
<tr class="row-odd"><td>OperationalState</td>
<td>ops_state_value</td>
<td>ops_state_sv.value</td>
</tr>
<tr class="row-even"><td>SimulationMode</td>
<td>sim_mode_value</td>
<td>sim_mode_sv.value</td>
</tr>
<tr class="row-odd"><td>ControlMode</td>
<td>control_mode_value</td>
<td>control_mode_sv.value</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>where the struct <cite>isample_motor_control</cite> is defined as:</p>
<blockquote>
<div><div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">isample_motor_control</span> <span class="p">{</span>
    <span class="kt">bool</span>             <span class="n">enable</span><span class="p">;</span>                  <span class="c1">// Axis Enable</span>
    <span class="kt">bool</span>             <span class="n">reset</span><span class="p">;</span>                   <span class="c1">// Axis Reset</span>
    <span class="kt">int16_t</span>          <span class="n">velocity</span><span class="p">;</span>                <span class="c1">// Velocity</span>
    <span class="n">MSGPACK_DEFINE_MAP</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span> <span class="n">velocity</span><span class="p">)</span>
<span class="p">};</span>
</pre></div>
</div>
</div></blockquote>
<p>and the struct <cite>HeartBeatEvent</cite> is defined as:</p>
<blockquote>
<div><div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">HeartBeatEvent</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">timeval</span>   <span class="n">timestamp</span><span class="p">;</span>               <span class="c1">// Time stamp</span>
    <span class="n">MSGPACK_DEFINE_MAP</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
<span class="p">};</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="optional-defining-component-behavior">
<h2>4.6. (Optional) Defining component behavior<a class="headerlink" href="#optional-defining-component-behavior" title="Permalink to this headline">¶</a></h2>
<p>The core component behavior is specified in the *_step.cpp file. The component
has a periodic thread that reads input from the input ports, runs the step
function and then writes output to the output ports. Initially, the generated
step function will check whether the component is correctly configured and if
so, will log the current step counter value.</p>
<p>In the following examples we will replace the basic step functionality with
simulated controller behavior.</p>
<p>To edit the <em>Filter Wheel Controller</em> step file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GMT_LOCAL</span>/modules/ocs_isample_dcs/src/cpp/
$ <span class="nb">cd</span> isample_ctrl_pkg/isample_filter_wheel_ctrl
$ vi isample_filter_wheel_ctrl_step.cpp
</pre></div>
</div>
<p>The following example step function for the filter wheel controller validates
positional input and immediately sets the position value to the new goal, if possible.</p>
<blockquote>
<div><div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">IsampleFilterWheelCtrl</span><span class="o">::</span><span class="n">step</span><span class="p">(</span><span class="kt">bool</span> <span class="n">setup_ok</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">setup_ok</span><span class="p">)</span> <span class="p">{</span>                     <span class="c1">// this will be executed only if port setup has been received</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_step_rate</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">goal</span> <span class="o">!=</span> <span class="n">position_sv</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// check range</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">goal</span> <span class="o">&gt;=</span> <span class="n">position_sv</span><span class="p">.</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">log_warning</span><span class="p">(</span><span class="s">&quot;Position is at or exceeding maximum value: &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">max</span><span class="p">));</span>
                    <span class="c1">// prevent further movement</span>
                    <span class="n">position_sv</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">position_sv</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">if</span> <span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">goal</span> <span class="o">&lt;=</span> <span class="n">position_sv</span><span class="p">.</span><span class="n">min</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">log_warning</span><span class="p">(</span><span class="s">&quot;Position is at or exceeding minimum value: &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">min</span><span class="p">));</span>
                    <span class="c1">// prevent further movement</span>
                    <span class="n">position_sv</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">position_sv</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// achieve target position immediately</span>
                    <span class="n">position_sv</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">position_sv</span><span class="p">.</span><span class="n">goal</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// report value</span>
                <span class="n">log_info</span><span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">position_sv</span><span class="p">.</span><span class="n">value</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="compilation">
<h2>4.7. Compilation<a class="headerlink" href="#compilation" title="Permalink to this headline">¶</a></h2>
<p>To compile the C++ Control Package code, edit the module.mk file to contain the correct library definitions:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ vi <span class="nv">$GMT_LOCAL</span>/modules/ocs_isample_dcs/src/cpp/isample_ctrl_pkg/module.mk
</pre></div>
</div>
<p>Ensure that the following lines are defined:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Add in this file the compile flags for the package, eg:</span>
<span class="nv">MOD_BUILD_LDFLAGS</span> <span class="o">+=</span> -lcore_core_pkg -lio_core_pkg -lctrl_core_pkg -lio_ethercat_pkg
<span class="nv">MOD_BUILD_LDFLAGS</span> <span class="o">+=</span> -lethercat -lopcuacore -lopcuaclient
</pre></div>
</div>
<p>Run <strong>make</strong> to compile the code:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GMT_LOCAL</span>/modules/ocs_isample_dcs/src/cpp
$ make
</pre></div>
</div>
</div>
<div class="section" id="running-the-example">
<h2>4.8. Running the Example<a class="headerlink" href="#running-the-example" title="Permalink to this headline">¶</a></h2>
<p>Start the logging and telemetry services:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ log_server <span class="p">&amp;</span>
$ tele_server <span class="p">&amp;</span>
</pre></div>
</div>
<p>Start the ISample Control Package application in the background</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ isample_ctrl_app <span class="p">&amp;</span>
</pre></div>
</div>
<p>The application is running in the background and will not provide any console output.
All output will be directed to the logging service after the components have been successfully set up.</p>
<div class="section" id="log-service">
<h3>4.8.1. Log Service<a class="headerlink" href="#log-service" title="Permalink to this headline">¶</a></h3>
<p>In a separate terminal (for example, <cite>tty2</cite>), <strong>start the logging service client</strong>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ log_client
</pre></div>
</div>
</div>
<div class="section" id="component-setup">
<h3>4.8.2. Component setup<a class="headerlink" href="#component-setup" title="Permalink to this headline">¶</a></h3>
<p>In the first terminal (<cite>tty1</cite>), <strong>initialize all components</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GMT_LOCAL</span>/modules/ocs_isample_dcs/src/etc
$ ./send_config.coffee
</pre></div>
</div>
<p>Switch to the session running the logging service client (<cite>tty2</cite>), and confirm
that the expected components are logging step info.</p>
</div>
<div class="section" id="telemetry-service">
<h3>4.8.3. Telemetry Service<a class="headerlink" href="#telemetry-service" title="Permalink to this headline">¶</a></h3>
<p>In a separate terminal (for example <cite>tty3</cite>), <strong>start the telemetry service client</strong>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ tele_client
</pre></div>
</div>
<p>In this example, we don’t filter, to show data for all monitors.
The output can be filtered on substrings of the monitor name by specifying the
topic to be a specific component type (<code class="docutils literal"><span class="pre">filter_wheel_ctrl</span></code>) or an output port
name, such as <code class="docutils literal"><span class="pre">position</span></code> or <code class="docutils literal"><span class="pre">heartbeat</span></code>. For example,</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tele_client --topic<span class="o">=</span>gmt://isample_dcs/isample_focus_ctrl/isample_focus1_ctrl/hmi_outputs
</pre></div>
</div>
<p>will show only the values of the <code class="docutils literal"><span class="pre">hmi_outputs</span></code> monitor from <code class="docutils literal"><span class="pre">isample_focus1_ctrl</span></code>.</p>
<p><a class="reference internal" href="#isample-example"><span class="std std-ref">[back to top]</span></a></p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="contribute.html" class="btn btn-neutral float-right" title="5. Contribute" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="virtual_machine/virtual_machine.html" class="btn btn-neutral" title="3. Installing a Virtual Machine" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, contributors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.4-1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>