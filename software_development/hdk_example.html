

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>11. HDK example &mdash; GMT Software And Controls documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/additional_style.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="GMT Software And Controls documentation" href="../index.html"/>
        <link rel="up" title="Software Development" href="index.html"/>
        <link rel="next" title="12. UI Framework" href="ui_fwk.html"/>
        <link rel="prev" title="10. ISample Example" href="isample_example.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> GMT Software And Controls
          

          
            
            <img src="../_static/logowhite.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                1.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../release_notes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SWC_architecture/index.html">Architecture and Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SWC_standards/index.html">Software and Controls Standards</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Software Development</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installation.html">1. Installing the SDK</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade.html">2. Upgrade</a></li>
<li class="toctree-l2"><a class="reference internal" href="virtual_machine/virtual_machine.html">3. Installing a Virtual Machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="gds_guide.html">4. gds documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="grs_guide.html">5. grs documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="modeling_guidelines.html">6. Model specification guide document</a></li>
<li class="toctree-l2"><a class="reference internal" href="model_language_mapping/index.html">7. Model-language mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="test_guidelines.html">8. OCS Test Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="core_services_user_guide.html">9. Core Services user guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="isample_example.html">10. ISample Example</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">11. HDK example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">11.1. Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hdk-hardware">11.2. HDK Hardware</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#connection-to-the-dcc">11.2.1. Connection to the DCC</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#hdk-software">11.3. HDK Software</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#clone-the-hdk-dcs-repository">11.3.1. Clone the hdk_dcs repository</a></li>
<li class="toctree-l4"><a class="reference internal" href="#model-files">11.3.2. Model files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-generation">11.3.3. Code generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compiling-configuration-files">11.3.4. Compiling Configuration Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hdk-main-controller-behavior">11.3.5. HDK Main Controller Behavior</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compilation">11.3.6. Compilation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-example">11.3.7. Running the Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#user-interface">11.4. User Interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configuration">11.4.1. Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-engineering-ui">11.4.2. Running the Engineering UI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#displaying-a-custom-ui-panel">11.4.3. Displaying a custom UI Panel</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ui_fwk.html">12. UI Framework</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../data_products/index.html">Data Products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary/swc_sys_glossary.html">Software and Controls Acronyms and Definitions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GMT Software And Controls</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Software Development</a> &raquo;</li>
        
      <li>11. HDK example</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hdk-example">
<span id="id1"></span><h1>11. HDK example<a class="headerlink" href="#hdk-example" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>11.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The HDK (Hardware Development Kit) is a tool which has the purpose of
serving as a template to facilitate the development of Device Control
Systems (DCS).</p>
</div>
<div class="section" id="hdk-hardware">
<h2>11.2. HDK Hardware<a class="headerlink" href="#hdk-hardware" title="Permalink to this headline">¶</a></h2>
<p>The main hardware component of the HDK is the control panel, displayed
in <a class="reference internal" href="#hdk-main-panel"><span class="std std-numref">Fig. 11.1</span></a>:</p>
<div class="figure" id="id2">
<span id="hdk-main-panel"></span><img alt="../_images/hdk_hw_panel.png" src="../_images/hdk_hw_panel.png" />
<p class="caption"><span class="caption-number">Fig. 11.1 </span><span class="caption-text">HDK Hardware Control Panel</span></p>
</div>
<p>The panel has two DIN rails with all the necessary components. The top rail
contains the power section on the left, an embedded PC in the central part,
and the Ethercat I/O modules on the right (<a class="reference internal" href="#hdk-io-modules"><span class="std std-numref">Fig. 11.2</span></a>),
as well as an emergency button (<a class="reference internal" href="#hdk-emergency-button"><span class="std std-numref">Fig. 11.3</span></a>).
The lower rail contains a stepper motor on the left with a
temperature probe (<a class="reference internal" href="#hdk-stepper"><span class="std std-numref">Fig. 11.4</span></a>), the terminal blocks interface
and a couple of push buttons with a led on the
right side (<a class="reference internal" href="#hdk-pushbuttons"><span class="std std-numref">Fig. 11.5</span></a>).</p>
<div class="figure" id="id3">
<span id="hdk-io-modules"></span><img alt="../_images/hdk_io_modules.png" src="../_images/hdk_io_modules.png" />
<p class="caption"><span class="caption-number">Fig. 11.2 </span><span class="caption-text">HDK I/O modules</span></p>
</div>
<div class="figure" id="id4">
<span id="hdk-emergency-button"></span><img alt="../_images/hdk_emergency_button.png" src="../_images/hdk_emergency_button.png" />
<p class="caption"><span class="caption-number">Fig. 11.3 </span><span class="caption-text">HDK emergency button</span></p>
</div>
<div class="figure" id="id5">
<span id="hdk-stepper"></span><img alt="../_images/hdk_stepper.png" src="../_images/hdk_stepper.png" />
<p class="caption"><span class="caption-number">Fig. 11.4 </span><span class="caption-text">HDK stepper motor</span></p>
</div>
<div class="figure" id="id6">
<span id="hdk-pushbuttons"></span><img alt="../_images/hdk_pushbuttons.png" src="../_images/hdk_pushbuttons.png" />
<p class="caption"><span class="caption-number">Fig. 11.5 </span><span class="caption-text">HDK pushbuttons</span></p>
</div>
<p>For more details on the HDK
hardware architecture, refer to GMT document GMT-SWC-DOC-00710.</p>
<div class="section" id="connection-to-the-dcc">
<h3>11.2.1. Connection to the DCC<a class="headerlink" href="#connection-to-the-dcc" title="Permalink to this headline">¶</a></h3>
<p>The HDK can be controlled using its embedded PC, or using a Real Time
Linux DCC. In this example we will use the latter option.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The following instructions assume that the Linux Real Time kernel
and the Ethercat drivers have been installed in the DCC, according
to the instructions in the <a class="reference internal" href="installation.html#installation"><span class="std std-ref">Installation Guide document</span></a>.</p>
</div>
<p>The EtherCAT bus must be connected to the RJ-45 connector that is located
to the left of the I/O modules block (see <a class="reference internal" href="#hdk-ethercat-bus"><span class="std std-numref">Fig. 11.6</span></a>). The other
end of the bus must be connected to the EtherCAT port of the Real Time Linux
DCC.</p>
<div class="figure" id="id7">
<span id="hdk-ethercat-bus"></span><img alt="../_images/hdk_ethercat_conn.png" src="../_images/hdk_ethercat_conn.png" />
<p class="caption"><span class="caption-number">Fig. 11.6 </span><span class="caption-text">HDK panel EtherCAT bus connection</span></p>
</div>
<p>We can check that the installation has been done correctly using the
<code class="docutils literal"><span class="pre">`ethercat`</span></code> command in the Linux machine. If we execute:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ethercat slaves
</pre></div>
</div>
<p>then the returned output must be:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="m">0</span>  <span class="m">0</span>:0  PREOP  +  EK1100 EtherCAT-Koppler <span class="o">(</span>2A E-Bus<span class="o">)</span>
<span class="m">1</span>  <span class="m">0</span>:1  PREOP  +  EL1008 8K. Dig. Eingang 24V, 3ms
<span class="m">2</span>  <span class="m">0</span>:2  PREOP  +  EL2008 8K. Dig. Ausgang 24V, <span class="m">0</span>.5A
<span class="m">3</span>  <span class="m">0</span>:3  PREOP  +  EL3002 2K.Ana. Eingang  +/-10V
<span class="m">4</span>  <span class="m">0</span>:4  PREOP  +  EL3202 2K.Ana. Eingang PT100 <span class="o">(</span>RTD<span class="o">)</span>
<span class="m">5</span>  <span class="m">0</span>:5  PREOP  +  EL4032 2K. Ana. Ausgang +/-10V, 12bit
<span class="m">6</span>  <span class="m">0</span>:6  PREOP  +  EL7041 1K. Schrittmotor-Endstufe <span class="o">(</span>50V, 5A<span class="o">)</span>
<span class="m">7</span>  <span class="m">0</span>:7  PREOP  +  EL9508 Netzteilklemme 8V
<span class="m">8</span>  <span class="m">0</span>:8  PREOP  +  EL3356 1K . Ana. Eingang, Widerstandsbr?cke, 16bit, hochgenau
<span class="m">9</span>  <span class="m">0</span>:9  PREOP  +  EL3356-0010 1K . Ana. Eingang, Widerstandsbr?cke, 24bit, hochge
</pre></div>
</div>
</div>
</div>
<div class="section" id="hdk-software">
<h2>11.3. HDK Software<a class="headerlink" href="#hdk-software" title="Permalink to this headline">¶</a></h2>
<div class="section" id="clone-the-hdk-dcs-repository">
<h3>11.3.1. Clone the hdk_dcs repository<a class="headerlink" href="#clone-the-hdk-dcs-repository" title="Permalink to this headline">¶</a></h3>
<p>On the real-time DCC, clone the repository in the development folder:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GMT_LOCAL</span>/modules
$ gds clone hdk_dcs -d gmto
</pre></div>
</div>
<p>where the <code class="docutils literal"><span class="pre">-d</span> <span class="pre">option</span></code> defines the git repository owner. The output of the
command will be:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Cloning into <span class="s1">&#39;ocs_hdk_dcs&#39;</span>...
remote: Counting objects: <span class="m">548</span>, <span class="k">done</span>.
remote: Compressing objects: <span class="m">100</span>% <span class="o">(</span><span class="m">44</span>/44<span class="o">)</span>, <span class="k">done</span>.
remote: Total <span class="m">548</span> <span class="o">(</span>delta <span class="m">7</span><span class="o">)</span>, reused <span class="m">19</span> <span class="o">(</span>delta <span class="m">1</span><span class="o">)</span>, pack-reused <span class="m">503</span>
Receiving objects: <span class="m">100</span>% <span class="o">(</span><span class="m">548</span>/548<span class="o">)</span>, <span class="m">97</span>.69 KiB <span class="p">|</span> <span class="m">1</span>.81 MiB/s, <span class="k">done</span>.
Resolving deltas: <span class="m">100</span>% <span class="o">(</span><span class="m">247</span>/247<span class="o">)</span>, <span class="k">done</span>.
<span class="o">[</span>INF<span class="o">]</span> <span class="o">[</span>gds<span class="o">]</span> clone module hdk_dcs
<span class="o">[</span>INF<span class="o">]</span> <span class="o">[</span>hdk_dcs<span class="o">]</span> Cloning module: hdk_dcs
</pre></div>
</div>
</div>
<div class="section" id="model-files">
<h3>11.3.2. Model files<a class="headerlink" href="#model-files" title="Permalink to this headline">¶</a></h3>
<p>The model files can be found in the <strong>$GMT_LOCAL/modules/ocs_hdk_dcs/model/</strong> folder.</p>
<dl class="docutils">
<dt>webpack.config.coffee</dt>
<dd>It has the <a class="reference external" href="https://webpack.js.org/">webpack</a> directives which are needed
to build the model</dd>
<dt>hdk_dcs_ld.coffee</dt>
<dd>It is the “loader” file. It contains the <code class="docutils literal"><span class="pre">`require`</span></code> directives to load
the rest of the files.</dd>
<dt>hdk_dcs.coffee</dt>
<dd>Lists the connectors between the components and the external environment.</dd>
<dt>hdk_dcs_def.coffee</dt>
<dd>High-level definition file, representing the WBS for the submodule. It lists
the components, as well as their implementation language, and other properties.</dd>
<dt>hdk_dcs_types.coffee</dt>
<dd>Definitions of structs and data types used by the HDK components.</dd>
<dt>hdk_dcs.rst</dt>
<dd>Text file, in RST format, describing the module.</dd>
<dt>hdk_ctrl_pkg/hdk_ctrl_fb.coffee</dt>
<dd>Fieldbus definitions for the HDK control package.</dd>
<dt>hdk_ctrl_pkg/hdk_ctrl_pkg.coffee</dt>
<dd>Lists the connectors between the components of the <em>hdk_ctrl_pkg</em> package.</dd>
<dt>hdk_ctrl_pkg/hdk_main_ctrl.coffee</dt>
<dd>Definition of the <em>Main HDK Controller</em> component. State variables, input and
output ports are specified here. A single instance called <strong>hdk_main_ctrl</strong>
will be created.</dd>
<dt>hdk_ctrl_pkg/hdk_hw_adapter.coffee</dt>
<dd>Definition of the <em>Hardware Adapter</em> component, used to interface with the HDK
Actuators and Sensors.
State variables, input and output ports are specified here.
A single instance called <strong>hdk_hw1_adapter</strong> will be created.</dd>
</dl>
<div class="highlight-bash"><div class="highlight"><pre><span></span> hdk_main_ctrl           hdk_hw_adapter         EtherCAT FB
+--------------+      +------------------+      +---------+
<span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>                  <span class="p">|</span>      <span class="p">|</span>         <span class="p">|</span>
<span class="p">|</span> hmi_inputs   <span class="p">|</span>&lt;-----<span class="p">|</span> operator_buttons <span class="p">|</span>      <span class="p">|</span>         <span class="p">|</span>
<span class="p">|</span> motor_state  <span class="p">|</span>&lt;-----<span class="p">|</span> motor_state      <span class="p">|</span>      <span class="p">|</span>         <span class="p">|</span>
<span class="p">|</span> temperatures <span class="p">|</span>&lt;-----<span class="p">|</span> temperatures     <span class="p">|</span>      <span class="p">|</span>         <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>                  <span class="p">|</span>&lt;----&gt;<span class="p">|</span>         <span class="p">|</span>
<span class="p">|</span> hmi_outputs  <span class="p">|</span>-----&gt;<span class="p">|</span> operator_leds    <span class="p">|</span>      <span class="p">|</span>         <span class="p">|</span>
<span class="p">|</span> motor_ctrl   <span class="p">|</span>-----&gt;<span class="p">|</span> motor_ctrl       <span class="p">|</span>      <span class="p">|</span>         <span class="p">|</span>
<span class="p">|</span> sdo_config   <span class="p">|</span>-----&gt;<span class="p">|</span> sdo_in           <span class="p">|</span>      <span class="p">|</span>         <span class="p">|</span>
<span class="p">|</span>              <span class="p">|</span>      <span class="p">|</span>                  <span class="p">|</span>      <span class="p">|</span>         <span class="p">|</span>
+--------------+      +------------------+      +---------+
</pre></div>
</div>
</div>
<div class="section" id="code-generation">
<h3>11.3.3. Code generation<a class="headerlink" href="#code-generation" title="Permalink to this headline">¶</a></h3>
<p>The hdk_dcs repository already has the source code of the HDK, so it is not
necessary to generate it.</p>
<p>If the source code needs to be generated
again (for example, if some feature to the components must be added), then
it can be done using the standard procedure:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GMT_LOCAL</span>/modules/ocs_hdk_dcs/model
$ webpack
$ gds gen hdk_dcs
</pre></div>
</div>
<p>After re-generating code from the model, all manual changes will need to be re-applied.</p>
</div>
<div class="section" id="compiling-configuration-files">
<h3>11.3.4. Compiling Configuration Files<a class="headerlink" href="#compiling-configuration-files" title="Permalink to this headline">¶</a></h3>
<p>Configuration files should be compiled for the C++ controllers. This can be done with:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>$ gds install  # Copies the configuration file to $GMT_LOCAL/etc/conf/
$ grs compile -i hdk_hw1_adapter
$ grs compile -i hdk_main_ctrl
$ grs compile --input $GMT_LOCAL/etc/conf/hdk_dcs/hdk_hw1_adapter_ethercat_default_conf.coffee --output $GMT_LOCAL/etc/conf/hdk_dcs/hdk_hw1_adapter_ethercat_default_conf.cfg
</pre></div>
</div>
</div>
<div class="section" id="hdk-main-controller-behavior">
<h3>11.3.5. HDK Main Controller Behavior<a class="headerlink" href="#hdk-main-controller-behavior" title="Permalink to this headline">¶</a></h3>
<p>The behavior of the HDK is defined in the <em>hdk_main_ctrl</em> component, and
more specifically, in the step() function of this controller.</p>
<p>The file that contains the HDK controller step function is <code class="docutils literal"><span class="pre">`HdkMainCtrl.cpp`</span></code>.
To visualize or edit it:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GMT_LOCAL</span>/modules/ocs_hdk_dcs/src/cpp/
$ <span class="nb">cd</span> hdk_ctrl_pkg/hdk_main_ctrl
$ vi HdkMainCtrl.cpp
</pre></div>
</div>
<p>The contents of the file is:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;HdkMainCtrl.h&quot;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">gmt</span><span class="p">;</span>

<span class="n">HdkMainCtrl</span><span class="o">::</span><span class="n">HdkMainCtrl</span><span class="p">(</span>
                        <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">comp_uri</span><span class="p">,</span>
                        <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">comp_name</span><span class="p">,</span>
                        <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">comp_host</span><span class="p">,</span>
                        <span class="kt">int</span> <span class="n">comp_port</span><span class="p">,</span>
                        <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">comp_acl</span><span class="p">,</span>
                        <span class="kt">double</span> <span class="n">comp_scan_rate</span><span class="p">,</span>
                        <span class="kt">int</span> <span class="n">comp_prio</span><span class="p">,</span>
                        <span class="kt">int</span> <span class="n">comp_stack_size</span><span class="p">)</span>
<span class="o">:</span> <span class="n">HdkMainCtrlBase</span><span class="p">(</span><span class="n">comp_uri</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">,</span> <span class="n">comp_host</span><span class="p">,</span> <span class="n">comp_port</span><span class="p">,</span> <span class="n">comp_acl</span><span class="p">,</span> <span class="n">comp_scan_rate</span><span class="p">,</span> <span class="n">comp_prio</span><span class="p">,</span> <span class="n">comp_stack_size</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">HdkMainCtrl</span><span class="o">::~</span><span class="n">HdkMainCtrl</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">HdkMainCtrl</span><span class="o">::</span><span class="n">step</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hmi_inputs_val</span><span class="p">.</span><span class="n">emergency_button</span><span class="p">)</span> <span class="p">{</span> <span class="n">motor_ctrl_req</span><span class="p">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">motor_ctrl_req</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">motor_state_val</span><span class="p">.</span><span class="n">ready</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">motor_state_val</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span> <span class="n">motor_ctrl_req</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// enable motor if not enabled</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">motor_state_val</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hmi_inputs_val</span><span class="p">.</span><span class="n">green_push_button</span><span class="p">)</span> <span class="p">{</span> <span class="n">motor_ctrl_req</span><span class="p">.</span><span class="n">velocity</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hmi_inputs_val</span><span class="p">.</span><span class="n">red_push_button</span><span class="p">)</span>   <span class="p">{</span> <span class="n">motor_ctrl_req</span><span class="p">.</span><span class="n">velocity</span><span class="o">--</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hmi_inputs_val</span><span class="p">.</span><span class="n">emergency_button</span><span class="p">)</span> <span class="p">{</span> <span class="n">motor_ctrl_req</span><span class="p">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">motor_ctrl_req</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="n">moving</span>                     <span class="o">=</span> <span class="n">motor_state_val</span><span class="p">.</span><span class="n">moving_positive</span> <span class="o">||</span> <span class="n">motor_state_val</span><span class="p">.</span><span class="n">moving_negative</span><span class="p">;</span>
    <span class="n">hmi_outputs_req</span><span class="p">.</span><span class="n">pilot</span>           <span class="o">=</span> <span class="n">moving</span><span class="p">;</span> <span class="c1">// pilot on when moving</span>
    <span class="n">hmi_outputs_req</span><span class="p">.</span><span class="n">emergency_light</span> <span class="o">=</span> <span class="o">!</span><span class="n">hmi_inputs_val</span><span class="p">.</span><span class="n">emergency_button</span><span class="p">;</span> <span class="c1">// ligth on when button pressed</span>
    <span class="kt">float</span> <span class="n">estimated_temperature</span> <span class="o">=</span> <span class="n">temperatures_val</span><span class="p">.</span><span class="n">temp_sensor1</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">;</span>  <span class="c1">// 10.0 will be a property</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">is_step_rate</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>    <span class="c1">// every 1000 steps = 1 second</span>
    <span class="p">{</span>

        <span class="c1">// following values should go to user interface</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Green button = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">hmi_inputs_val</span><span class="p">.</span><span class="n">green_push_button</span><span class="p">));</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Red button   = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">hmi_inputs_val</span><span class="p">.</span><span class="n">red_push_button</span><span class="p">));</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Emergency    = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">hmi_inputs_val</span><span class="p">.</span><span class="n">emergency_button</span><span class="p">));</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Temperature  = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">estimated_temperature</span><span class="p">));</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Temperature1 = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">temperatures_val</span><span class="p">.</span><span class="n">temp_sensor1</span><span class="p">));</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Temperature2 = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">temperatures_val</span><span class="p">.</span><span class="n">temp_sensor2</span><span class="p">));</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Axis Ready   = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">motor_state_val</span><span class="p">.</span><span class="n">ready</span><span class="p">));</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Axis Enabled = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">motor_state_val</span><span class="p">.</span><span class="n">enabled</span><span class="p">));</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Axis Warning = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">motor_state_val</span><span class="p">.</span><span class="n">warning</span><span class="p">));</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Axis Error   = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">motor_state_val</span><span class="p">.</span><span class="n">error</span><span class="p">));</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Axis Moving+ = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">motor_state_val</span><span class="p">.</span><span class="n">moving_positive</span><span class="p">));</span>
        <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Axis Moving- = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">motor_state_val</span><span class="p">.</span><span class="n">moving_negative</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">is_step_rate</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">hmi_outputs_req</span><span class="p">.</span><span class="n">heartbeat</span> <span class="o">=</span> <span class="o">!</span><span class="n">hmi_outputs_req</span><span class="p">.</span><span class="n">heartbeat</span><span class="p">;</span> <span class="c1">// flip bit on each step to indicate component is alive</span>
    <span class="p">}</span>

    <span class="n">hmi</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">hmi_inputs_val</span><span class="p">;</span>
    <span class="n">hmi</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">hmi_outputs_req</span><span class="p">;</span>
    <span class="n">motor</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">motor_state_val</span><span class="p">;</span>
    <span class="n">motor</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">motor_ctrl_req</span><span class="p">;</span>
    <span class="n">temperatures</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">temperatures_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">HdkMainCtrl</span><span class="o">::</span><span class="n">setup</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//setup async input handlers</span>

    <span class="c1">//ex: new_async_input_handler (&quot;input_name&quot;, this, &amp;HdkMainCtrl::input_handler);</span>

    <span class="c1">//add behaviors to features</span>

    <span class="c1">//other initializations</span>

<span class="p">}</span>
</pre></div>
</div>
<p>This step function has 5 parts:</p>
<ol class="arabic simple">
<li>Emergency button</li>
<li>Motor control</li>
<li>LEDs control</li>
<li>Logs</li>
<li>Heartbeat LED</li>
</ol>
<div class="section" id="step-function-emergency-button-section">
<h4>11.3.5.1. Step function. Emergency button section<a class="headerlink" href="#step-function-emergency-button-section" title="Permalink to this headline">¶</a></h4>
<p>The first code block of the step function is</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hmi_inputs</span><span class="p">.</span><span class="n">emergency_button</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">motor_ctrl</span><span class="p">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">motor_ctrl</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">motor_state</span><span class="p">.</span><span class="n">ready</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">motor_state</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// enable motor if not enabled</span>
    <span class="n">motor_ctrl</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the field <code class="docutils literal"><span class="pre">`emergency_button`</span></code> of the <code class="docutils literal"><span class="pre">`hmi_inputs`</span></code> input
port we have the state of the emergency button, in inverse logic
(so it is <code class="docutils literal"><span class="pre">False</span></code> when it is pushed, and <code class="docutils literal"><span class="pre">True</span></code> when not). The
above code block disables the stepper motor and sets the velocity to
0 when the emergency button is activated, and enables the motor
if not.</p>
</div>
<div class="section" id="step-function-motor-control">
<h4>11.3.5.2. Step function. Motor control<a class="headerlink" href="#step-function-motor-control" title="Permalink to this headline">¶</a></h4>
<p>The next section of code implements the motor control:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">motor_state</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hmi_inputs</span><span class="p">.</span><span class="n">green_push_button</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">motor_ctrl</span><span class="p">.</span><span class="n">velocity</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">hmi_inputs</span><span class="p">.</span><span class="n">red_push_button</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">motor_ctrl</span><span class="p">.</span><span class="n">velocity</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hmi_inputs</span><span class="p">.</span><span class="n">emergency_button</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">motor_ctrl</span><span class="p">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">motor_ctrl</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the <code class="docutils literal"><span class="pre">`green_push_button`</span></code> field of the <code class="docutils literal"><span class="pre">`hmi_inputs`</span></code> input
port we have the state of the green push button of the HDK panel (<code class="docutils literal"><span class="pre">True</span></code>
when pushed, <code class="docutils literal"><span class="pre">False</span></code> when not) and in the field <code class="docutils literal"><span class="pre">`red_push_button`</span></code>
we have the state of the red button (see <a class="reference internal" href="#hdk-pushbuttons"><span class="std std-numref">Fig. 11.5</span></a>).</p>
<p>The <code class="docutils literal"><span class="pre">`motor_ctrl`</span></code> output port has 3 fields: the <code class="docutils literal"><span class="pre">`velocity`</span></code> field,
which will be forwarded to the stepper motor as the velocity set point; the
<code class="docutils literal"><span class="pre">`enable`</span></code>, which will control if the motor is enabled or not; and the
<code class="docutils literal"><span class="pre">`reset`</span></code>, which resets the motor in case of failure.</p>
<p>The logic of the section is straightforward: if the green button is pushed,
the velocity will be increased; if the red button is pushed the velocity
will be decreased; and if the emergency button is pushed then the motor is
disabled.</p>
</div>
<div class="section" id="step-function-leds-control">
<h4>11.3.5.3. Step function. LEDs control<a class="headerlink" href="#step-function-leds-control" title="Permalink to this headline">¶</a></h4>
<p>The next code section takes care of the control of the LEDs:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">moving</span> <span class="o">=</span> <span class="n">motor_state</span><span class="p">.</span><span class="n">moving_positive</span> <span class="o">||</span> <span class="n">motor_state</span><span class="p">.</span><span class="n">moving_negative</span><span class="p">;</span>
<span class="n">hmi_outputs</span><span class="p">.</span><span class="n">pilot</span> <span class="o">=</span> <span class="n">moving</span><span class="p">;</span> <span class="c1">// pilot on when moving</span>
<span class="n">hmi_outputs</span><span class="p">.</span><span class="n">emergency_light</span> <span class="o">=</span> <span class="o">!</span><span class="n">hmi_inputs</span><span class="p">.</span><span class="n">emergency_button</span><span class="p">;</span> <span class="c1">// ligth on when button pressed</span>
</pre></div>
</div>
<p>In the fist line we read the motion state of the stepper motor, and in the
second line we light the white led (see <a class="reference internal" href="#hdk-pushbuttons"><span class="std std-numref">Fig. 11.5</span></a>) if the motor is moving. In the third
line, we light the red led (<a class="reference internal" href="#hdk-emergency-button"><span class="std std-numref">Fig. 11.3</span></a>) if the emergency
button is pushed.</p>
</div>
<div class="section" id="step-function-logs">
<h4>11.3.5.4. Step function. Logs<a class="headerlink" href="#step-function-logs" title="Permalink to this headline">¶</a></h4>
<p>Once each second, the HDK application produces some logs to inform about
the slaves readings:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">is_step_rate</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>    <span class="c1">// every 100 steps = 1 second</span>
<span class="p">{</span>
    <span class="c1">// following values should go to user interface</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Green button = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">hmi_inputs</span><span class="p">.</span><span class="n">green_push_button</span><span class="p">));</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Red button   = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">hmi_inputs</span><span class="p">.</span><span class="n">red_push_button</span><span class="p">));</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Emergency    = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">hmi_inputs</span><span class="p">.</span><span class="n">emergency_button</span><span class="p">));</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Temperature  = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">estimated_temperature</span><span class="p">));</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Temperature1 = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">temperatures</span><span class="p">.</span><span class="n">temp_sensor1</span><span class="p">));</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Temperature2 = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">temperatures</span><span class="p">.</span><span class="n">temp_sensor2</span><span class="p">));</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Axis Ready   = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">motor_state</span><span class="p">.</span><span class="n">ready</span><span class="p">));</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Axis Enabled = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">motor_state</span><span class="p">.</span><span class="n">enabled</span><span class="p">));</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Axis Warning = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">motor_state</span><span class="p">.</span><span class="n">warning</span><span class="p">));</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Axis Error   = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">motor_state</span><span class="p">.</span><span class="n">error</span><span class="p">));</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Axis Moving+ = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">motor_state</span><span class="p">.</span><span class="n">moving_positive</span><span class="p">));</span>
    <span class="n">log_info</span><span class="p">(</span><span class="s">&quot;Axis Moving- = &quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">motor_state</span><span class="p">.</span><span class="n">moving_negative</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">`is_step_rate(num)`</span></code> function returns true once each <code class="docutils literal"><span class="pre">`num`</span></code> steps, so the
above code gets executed once each 100 steps. As the HDK scan rate is 100 Hz,
this section is entered once each second.</p>
<p>Inside the <em>if</em> statement we have several <code class="docutils literal"><span class="pre">`log_info`</span></code> to show the different
variables. The <code class="docutils literal"><span class="pre">`log_info`</span></code> method is inherited from the <em>BaseComponent</em> base
class, and it sends the given string to the Log Service.</p>
</div>
<div class="section" id="step-function-heartbeat-led">
<h4>11.3.5.5. Step function. Heartbeat LED<a class="headerlink" href="#step-function-heartbeat-led" title="Permalink to this headline">¶</a></h4>
<p>Finally, the section</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">is_step_rate</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>  <span class="c1">// every 500 steps = 5 seconds</span>
<span class="p">{</span>
    <span class="c1">// flip bit to indicate component is alive</span>
    <span class="n">hmi_outputs</span><span class="p">.</span><span class="n">heartbeat</span> <span class="o">=</span> <span class="o">!</span><span class="n">hmi_outputs</span><span class="p">.</span><span class="n">heartbeat</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>inverts the state of the heartbeat LED, with a period of 5 seconds. This
digital output is not actually wired to any hardware device, but the
change is visible in the LED array of the digital output EL2008 Ethercat slave.</p>
</div>
</div>
<div class="section" id="compilation">
<h3>11.3.6. Compilation<a class="headerlink" href="#compilation" title="Permalink to this headline">¶</a></h3>
<p>To compile the C++ Control Package code of the HDK, edit the module.mk file to
contain the correct library definitions:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ vi <span class="nv">$GMT_LOCAL</span>/modules/ocs_hdk_dcs/src/cpp/hdk_ctrl_pkg/module.mk
</pre></div>
</div>
<p>Ensure that the following lines are defined:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Add in this file the compile flags for the package, eg:</span>
<span class="nv">MOD_BUILD_LDFLAGS</span> <span class="o">+=</span> -lcore_core_pkg -lio_core_pkg -lctrl_core_pkg -lio_ethercat_pkg
<span class="nv">MOD_BUILD_LDFLAGS</span> <span class="o">+=</span> -lethercat
</pre></div>
</div>
<p>Run <strong>make</strong> to compile the code:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GMT_LOCAL</span>/modules/ocs_hdk_dcs/src/cpp
$ make
</pre></div>
</div>
</div>
<div class="section" id="running-the-example">
<h3>11.3.7. Running the Example<a class="headerlink" href="#running-the-example" title="Permalink to this headline">¶</a></h3>
<p>Start the logging and telemetry services:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ log_server <span class="p">&amp;</span>
$ tele_server <span class="p">&amp;</span>
</pre></div>
</div>
<p>Start the HDK application in the background</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ hdk_ctrl_app <span class="p">&amp;</span>
</pre></div>
</div>
<p>The application is running in the background and will not provide any console output.
All output will be directed to the logging service after the components have been successfully set up.</p>
<div class="section" id="log-client">
<h4>11.3.7.1. Log client<a class="headerlink" href="#log-client" title="Permalink to this headline">¶</a></h4>
<p>In a separate terminal (for example, <cite>tty2</cite>), <strong>start the logging service client</strong>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ log_client listen
</pre></div>
</div>
</div>
<div class="section" id="telemetry-client">
<h4>11.3.7.2. Telemetry client<a class="headerlink" href="#telemetry-client" title="Permalink to this headline">¶</a></h4>
<p>In a separate terminal (for example <cite>tty3</cite>), <strong>start the telemetry service client</strong>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ tele_client listen
</pre></div>
</div>
</div>
<div class="section" id="hdk-operation">
<h4>11.3.7.3. HDK operation<a class="headerlink" href="#hdk-operation" title="Permalink to this headline">¶</a></h4>
<p>Now the HDK is available to be operated. The behaviour of the system
will be the described one:</p>
<ul class="simple">
<li>If the emergency button is pressed, then the stepper motor will be
disabled, and the red led of the emergency button will be on.</li>
<li>If the emergency button is released, then the stepper motor will be
enabled, and the red led of the emergency button will be off.</li>
<li>When the emergency button is released, if the green button is pushed
then the velocity of the stepper motor will be increased.</li>
<li>When the emergency button is released, if the red button is pushed
then the velocity of the stepper motor will be decreased.</li>
<li>If the motor is moving, then the pilot led between the buttons will
be on.</li>
</ul>
</div>
</div>
</div>
<div class="section" id="user-interface">
<h2>11.4. User Interface<a class="headerlink" href="#user-interface" title="Permalink to this headline">¶</a></h2>
<p>The Navigator application displays the Engineering user interface as well as any
custom panels defined in the subsystem’s Visualization Package. Engineering panels
are automatically generated from the Model files, whereas custom panels need to
be created manually.</p>
<img alt="Navigator application" class="align-center" src="../_images/Navigator_HDK_first_open.png" />
<p>The HDK DCS contains basic examples of these user interface panels with limited functionality.
More detailed examples will be added in the future as the UI Framework matures.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The UI framework is currently only supported on MacOS.  Linux support will be available in future releases.</p>
</div>
<div class="section" id="configuration">
<h3>11.4.1. Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>In order to receive data, the User Interface needs to be configured with the correct URIs for connecting to control components that may be running on a different machine. The UI will display the message “Waiting for data” for components it cannot connect to.</p>
<img alt="Navigator application - No connection to HDK components" class="align-center" src="../_images/Navigator_HDK_noconnection.png" />
<p>Edit the appropriate config files in the <code class="docutils literal"><span class="pre">src/etc/conf</span></code> folder to point to the correct IP address for input and output ports. For example,</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$GMT_LOCAL</span>/modules/ocs_hdk_dcs/src/etc/conf/hdk_ctrl_pkg/hdk_main_ctrl/
$ sed -i <span class="s1">&#39;&#39;</span> <span class="s2">&quot;s/172.0.0.1/172.16.10.31/g&quot;</span> hdk_main_ctrl_config.coffee
</pre></div>
</div>
<p>Also note that the firewall on the machine running the control components need to be configured to allow data through the input/output ports that the UI is trying to connect to. Use <code class="docutils literal"><span class="pre">firewall-cmd</span></code> to open the applicable ports (for example, the range from 8122 to 8124):</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo firewall-cmd --add-port<span class="o">=</span><span class="m">8122</span>-8124/tcp
</pre></div>
</div>
</div></blockquote>
<p>See the Troubleshooting section in the <a class="reference internal" href="ui_fwk.html#ui-fwk"><span class="std std-ref">UI Framework Guidelines document</span></a> for more help with connection issues.</p>
<p>The following screenshot shows that the configuration is correct, but the remote control components are not running.</p>
<img alt="Navigator application" class="align-center" src="../_images/Navigator_HDK_nodata.png" />
</div>
<div class="section" id="running-the-engineering-ui">
<h3>11.4.2. Running the Engineering UI<a class="headerlink" href="#running-the-engineering-ui" title="Permalink to this headline">¶</a></h3>
<p>The Engineering UI uses your local bundles file (found in <code class="docutils literal"><span class="pre">$GMT_LOCAL/etc/bundles</span></code>) to automatically create
a visual representation of the modules being worked on by loading the input/output port definitions
in the relevant Model files.</p>
<p>For now, the Engineering application needs to run in MacOS. Ensure that it has been configured correctly
using the <a class="reference internal" href="installation.html#installation"><span class="std std-ref">Installation Guide document</span></a>.</p>
<p>To launch the Navigator application, run this in the command line</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ navigator
</pre></div>
</div>
<p>This will launch the GUI as a child process of the CLI application.  To stop the GUI, stop the CLI app with <code class="docutils literal"><span class="pre">CTRL</span> <span class="pre">+</span> <span class="pre">C</span></code>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Some users have noted an issue when running this command from $GMT_LOCAL. If the UI doesn’t load properly, try running it from a different location.</p>
</div>
<p>If necessary, see the Troubleshooting section in the <a class="reference internal" href="ui_fwk.html#ui-fwk"><span class="std std-ref">UI Framework Guidelines document</span></a>.</p>
<p>On the left-hand side of the UI, use the tree structure to navigate to the HDK components. Selecting the appropriate component will provide a panel in the <cite>Context</cite> area with the input/output ports and state variables defined in the Model.</p>
<img alt="Navigator application - HDK Engineering UI Context" class="align-center" src="../_images/Navigator_HDK_connected.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <strong>Context</strong> area will optimistically render your model.  Not all model data can be rendered by the current version of the software. Some items like <cite>properties</cite> and detailed port views are currently not supported.</p>
</div>
</div>
<div class="section" id="displaying-a-custom-ui-panel">
<h3>11.4.3. Displaying a custom UI Panel<a class="headerlink" href="#displaying-a-custom-ui-panel" title="Permalink to this headline">¶</a></h3>
<p>The UI Framework allows the definition of custom UI panels for visualization of data using special UI components (for example, <cite>panels</cite> and <cite>widgets</cite>). Custom panels are defined in the Visualization Package of the Device Control System.</p>
<p>The Navigator application can launch standalone panels with the <code class="docutils literal"><span class="pre">--panel</span></code> option to only focus in on the custom HDK panel:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ navigator --panel hdk_main_ctrl_view --port <span class="m">9198</span>
</pre></div>
</div>
<p>The entire screen is now dedicated to displaying the custom UI panel.</p>
<img alt="Navigator application - HDK Custom UI Panel" class="align-center" src="../_images/Navigator_HDK_custom_panel.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The engineering app reserves port <code class="docutils literal"><span class="pre">9199</span></code>.  Custom panel launches of the application need to specify a different port for each instance. The navigator app allows you to run instances of multiple panels at the same time.  However, you will need to specify a different <code class="docutils literal"><span class="pre">--port</span></code> for each instance to avoid port collision errors.  Also, note that the navigator app will reuse the internal data server for multiple instances, so if you close the initial instance, the data server may become unavailable for the other panels.</p>
</div>
<p>For more information on creating custom UI panels, see the <a class="reference internal" href="ui_fwk.html#ui-fwk"><span class="std std-ref">UI Framework Guidelines document</span></a>.</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ui_fwk.html" class="btn btn-neutral float-right" title="12. UI Framework" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="isample_example.html" class="btn btn-neutral" title="10. ISample Example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, contributors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.6.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>